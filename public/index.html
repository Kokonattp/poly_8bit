<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolyMarket Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    :root {
      --bg-primary: #f8f9fc;
      --bg-secondary: #ffffff;
      --bg-card: #ffffff;
      --bg-hover: #f0f2f5;
      --text-primary: #1a1a2e;
      --text-secondary: #6b7280;
      --text-muted: #9ca3af;
      --border: #e5e7eb;
      --border-light: #f0f2f5;
      --accent: #7c5cff;
      --accent-light: rgba(124, 92, 255, 0.1);
      --accent-gradient: linear-gradient(135deg, #7c5cff 0%, #a78bfa 100%);
      --success: #10b981;
      --success-light: rgba(16, 185, 129, 0.1);
      --danger: #ef4444;
      --danger-light: rgba(239, 68, 68, 0.1);
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.1);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.15), 0 6px 12px rgba(0,0,0,0.1);
      --shadow-card: 0 4px 12px rgba(0,0,0,0.12), 0 2px 4px rgba(0,0,0,0.08);
      --shadow-card-hover: 0 16px 32px rgba(0,0,0,0.18), 0 8px 16px rgba(0,0,0,0.12);
    }

    [data-theme="dark"] {
      --bg-primary: #0f0f14;
      --bg-secondary: #16161f;
      --bg-card: #1a1a25;
      --bg-hover: #22222e;
      --text-primary: #f0f0f5;
      --text-secondary: #9999b0;
      --text-muted: #6b6b80;
      --border: #2a2a3a;
      --border-light: #22222e;
      --shadow-sm: 0 2px 4px rgba(0,0,0,0.4), 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 8px rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.4);
      --shadow-lg: 0 12px 24px rgba(0,0,0,0.6), 0 6px 12px rgba(0,0,0,0.5);
      --shadow-card: 0 4px 12px rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.4);
      --shadow-card-hover: 0 16px 32px rgba(0,0,0,0.7), 0 8px 16px rgba(0,0,0,0.5);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    body { 
      font-family: 'DM Sans', -apple-system, sans-serif; 
      background: var(--bg-primary); 
      color: var(--text-primary); 
      min-height: 100vh;
      -webkit-font-smoothing: antialiased;
      transition: background 0.3s, color 0.3s;
    }
    
    .header { 
      background: var(--bg-secondary); 
      padding: 14px 24px; 
      position: sticky; 
      top: 0; 
      z-index: 100; 
      border-bottom: 1px solid var(--border);
    }
    .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 10px; }
    .logo-icon { 
      width: 36px; height: 36px; 
      background: var(--accent-gradient); 
      border-radius: 10px; 
      display: flex; align-items: center; justify-content: center; 
      font-weight: 700; font-size: 16px; color: #fff;
    }
    .logo h1 { font-size: 20px; font-weight: 700; color: var(--text-primary); }
    .logo sup { font-size: 10px; color: var(--accent); font-weight: 600; margin-left: 2px; }
    .header-right { display: flex; gap: 10px; align-items: center; }
    
    .theme-toggle {
      width: 44px; height: 44px;
      border-radius: 12px;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      font-size: 18px;
      transition: all 0.2s;
    }
    .theme-toggle:hover { background: var(--accent-light); border-color: var(--accent); }
    
    .btn { 
      padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; 
      cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; 
      display: inline-flex; align-items: center; gap: 6px;
      font-family: 'DM Sans', sans-serif;
    }
    .btn-outline { 
      background: transparent; 
      color: var(--text-primary); 
      border: 1px solid var(--border);
    }
    .btn-outline:hover { background: var(--bg-hover); }
    .btn-primary { 
      background: var(--accent-gradient); 
      color: #fff; 
      border: none;
    }
    .btn-primary:hover { opacity: 0.9; transform: translateY(-1px); }

    .main { max-width: 1400px; margin: 0 auto; padding: 24px; }

    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 14px; margin-bottom: 24px; }
    @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr; } }
    .stat-card { 
      background: var(--bg-card); 
      border-radius: 16px; 
      padding: 20px; 
      border: 1px solid var(--border);
      transition: all 0.2s;
      box-shadow: var(--shadow-card);
    }
    .stat-card:hover { box-shadow: var(--shadow-card-hover); transform: translateY(-3px); }
    .stat-card .icon { 
      width: 40px; height: 40px; border-radius: 12px; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 18px; margin-bottom: 12px;
      background: var(--accent-light);
    }
    .stat-card p { color: var(--text-secondary); font-size: 13px; margin-bottom: 4px; font-weight: 500; }
    .stat-card h3 { font-size: 24px; font-weight: 700; }
    .text-accent { color: var(--accent); }
    .text-success { color: var(--success); }
    .text-danger { color: var(--danger); }

    .categories { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .cat-btn { 
      padding: 10px 20px; border-radius: 10px; font-size: 14px; font-weight: 600; 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .cat-btn:hover { border-color: var(--accent); color: var(--accent); }
    .cat-btn.active { 
      background: var(--accent-gradient); 
      border-color: transparent; 
      color: #fff;
    }

    .toolbar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 260px; position: relative; }
    .search-box input { 
      width: 100%; padding: 14px 16px 14px 46px; 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 12px; font-size: 14px; color: var(--text-primary); outline: none; 
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .search-box input::placeholder { color: var(--text-muted); }
    .search-box input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-light); }
    .search-box::before { content: 'üîç'; position: absolute; left: 16px; top: 50%; transform: translateY(-50%); font-size: 14px; }
    select { 
      padding: 14px 16px; 
      background: var(--bg-card); 
      border: 1px solid var(--border); 
      border-radius: 12px; font-size: 14px; color: var(--text-primary); cursor: pointer; outline: none;
      font-family: 'DM Sans', sans-serif; font-weight: 500;
    }
    select:focus { border-color: var(--accent); }

    .markets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 16px; }
    @media (max-width: 500px) { .markets-grid { grid-template-columns: 1fr; } }

    .market-card { 
      background: var(--bg-card); 
      border-radius: 16px; 
      overflow: hidden; 
      border: 1px solid var(--border);
      transition: all 0.25s; 
      cursor: pointer;
      box-shadow: var(--shadow-card);
    }
    .market-card:hover { 
      box-shadow: var(--shadow-card-hover); 
      transform: translateY(-4px);
      border-color: var(--accent);
    }
    .market-header { display: flex; gap: 14px; padding: 18px; }
    .market-rank { 
      width: 32px; height: 32px; border-radius: 8px; 
      display: flex; align-items: center; justify-content: center; 
      font-size: 13px; font-weight: 700; 
      background: var(--bg-hover); color: var(--text-secondary); flex-shrink: 0;
    }
    .market-rank.r1 { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a2e; }
    .market-rank.r2 { background: linear-gradient(135deg, #e0e0e0, #b0b0b0); color: #1a1a2e; }
    .market-rank.r3 { background: linear-gradient(135deg, #cd7f32, #b5651d); color: #fff; }
    .market-img { 
      width: 52px; height: 52px; border-radius: 12px; object-fit: cover; 
      background: var(--bg-hover); flex-shrink: 0;
    }
    .market-info { flex: 1; min-width: 0; }
    .market-info h3 { 
      font-size: 15px; font-weight: 600; line-height: 1.4; 
      display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; 
      color: var(--text-primary);
    }
    .market-tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .tag { 
      font-size: 11px; padding: 4px 10px; 
      background: var(--accent-light); 
      border-radius: 6px; color: var(--accent); font-weight: 600;
    }

    .market-outcomes { padding: 0 18px 16px; }
    .outcome-row { 
      display: flex; align-items: center; gap: 12px; 
      padding: 10px 0; border-bottom: 1px solid var(--border-light);
    }
    .outcome-row:last-child { border-bottom: none; }
    .outcome-name { flex: 1; font-size: 13px; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; }
    .outcome-price { font-size: 14px; font-weight: 700; min-width: 45px; text-align: right; font-family: 'JetBrains Mono', monospace; }
    .outcome-change { 
      font-size: 11px; font-weight: 600; min-width: 55px; text-align: right; 
      font-family: 'JetBrains Mono', monospace;
      padding: 3px 8px;
      border-radius: 6px;
    }
    .outcome-change.up { color: var(--success); background: var(--success-light); }
    .outcome-change.down { color: var(--danger); background: var(--danger-light); }
    .outcome-bar { width: 70px; height: 5px; background: var(--border); border-radius: 3px; overflow: hidden; }
    .outcome-bar-fill { height: 100%; background: var(--accent-gradient); border-radius: 3px; }

    .market-footer { 
      display: flex; justify-content: space-between; 
      padding: 12px 18px; 
      background: var(--bg-hover); 
      font-size: 12px; color: var(--text-secondary); font-weight: 500;
    }
    .market-footer span { display: flex; align-items: center; gap: 5px; }

    .pagination { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 32px; }
    .pagination button { 
      padding: 10px 24px; border-radius: 10px; 
      border: 1px solid var(--border); 
      background: var(--bg-card); 
      color: var(--text-primary); font-weight: 600; cursor: pointer; transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .pagination button:hover:not(:disabled) { border-color: var(--accent); color: var(--accent); }
    .pagination button:disabled { opacity: 0.4; cursor: not-allowed; }

    .loading { text-align: center; padding: 60px; color: var(--text-secondary); grid-column: 1/-1; }
    .spinner { 
      width: 36px; height: 36px; 
      border: 3px solid var(--border); 
      border-top-color: var(--accent); 
      border-radius: 50%; 
      animation: spin 0.8s linear infinite; 
      margin: 0 auto 14px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    .modal-overlay { 
      position: fixed; inset: 0; 
      background: rgba(0,0,0,0.5); 
      backdrop-filter: blur(8px); 
      z-index: 200; display: none; 
      padding: 20px; overflow-y: auto;
    }
    .modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }
    .modal { 
      background: var(--bg-card); 
      border-radius: 20px; 
      width: 100%; max-width: 800px; 
      overflow: hidden; margin: auto; 
      border: 1px solid var(--border);
      box-shadow: var(--shadow-lg);
    }
    .modal-header { 
      padding: 24px; 
      border-bottom: 1px solid var(--border);
    }
    .modal-header-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .modal-header h2 { font-size: 20px; font-weight: 700; line-height: 1.4; color: var(--text-primary); }
    .modal-header p { color: var(--text-secondary); font-size: 13px; margin-top: 6px; font-weight: 500; }
    .close-btn { 
      width: 38px; height: 38px; border-radius: 10px; 
      background: var(--bg-hover); 
      border: 1px solid var(--border); 
      cursor: pointer; font-size: 16px; color: var(--text-secondary); flex-shrink: 0; transition: all 0.2s;
    }
    .close-btn:hover { background: var(--danger-light); border-color: var(--danger); color: var(--danger); }

    .event-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 20px 24px; background: var(--bg-primary); }
    @media (max-width: 600px) { .event-stats { grid-template-columns: repeat(2, 1fr); } }
    .event-stat { 
      background: var(--bg-card); 
      padding: 16px; 
      border-radius: 12px; 
      text-align: center;
      border: 1px solid var(--border);
    }
    .event-stat h4 { font-size: 20px; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }
    .event-stat p { font-size: 11px; color: var(--text-secondary); margin-top: 4px; font-weight: 600; text-transform: uppercase; }

    .section { padding: 20px 24px; }
    .section-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; flex-wrap: wrap; gap: 12px; }
    .section-title { 
      font-size: 14px; font-weight: 700; 
      display: flex; align-items: center; gap: 8px; color: var(--text-primary);
    }
    .sort-toggle { display: flex; gap: 6px; }
    .sort-btn {
      padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600;
      background: var(--bg-hover); border: 1px solid var(--border);
      color: var(--text-secondary); cursor: pointer; transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .sort-btn:hover { border-color: var(--accent); color: var(--accent); }
    .sort-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

    /* Insights Panel */
    .insights-panel {
      background: var(--bg-card);
      border-radius: 14px;
      padding: 18px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
    }
    .insights-panel:hover { box-shadow: var(--shadow-md); }
    .insights-title { font-size: 13px; font-weight: 700; color: var(--accent); margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 12px; }
    .insight-item {
      background: var(--bg-primary);
      padding: 14px;
      border-radius: 10px;
      border: 1px solid var(--border);
    }
    .insight-item .label { font-size: 11px; color: var(--text-muted); font-weight: 600; text-transform: uppercase; margin-bottom: 4px; }
    .insight-item .value { font-size: 16px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .insight-item .hint { font-size: 10px; color: var(--text-muted); margin-top: 4px; }

    .outcomes-list { display: flex; flex-direction: column; gap: 10px; max-height: 350px; overflow-y: auto; }
    .outcome-card { 
      display: flex; align-items: center; gap: 14px; 
      padding: 16px 18px; 
      background: var(--bg-card); 
      border-radius: 14px; 
      cursor: pointer; transition: all 0.2s; 
      border: 1px solid var(--border);
      box-shadow: var(--shadow-card);
    }
    .outcome-card:hover { background: var(--bg-hover); transform: translateY(-2px); box-shadow: var(--shadow-card-hover); }
    .outcome-card.selected { border-color: var(--accent); background: var(--accent-light); box-shadow: 0 0 0 3px var(--accent-light), var(--shadow-card); }
    .outcome-num { 
      width: 30px; height: 30px; border-radius: 8px; 
      background: var(--bg-hover); 
      display: flex; align-items: center; justify-content: center; 
      font-size: 12px; font-weight: 700; color: var(--text-secondary);
    }
    .outcome-num.top { background: var(--accent-gradient); color: #fff; }
    .outcome-details { flex: 1; min-width: 0; }
    .outcome-details h4 { font-size: 14px; font-weight: 600; color: var(--text-primary); }
    .outcome-details p { font-size: 11px; color: var(--text-muted); margin-top: 3px; font-weight: 500; }
    .outcome-price-box { text-align: right; }
    .outcome-price-box h4 { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .outcome-btns { display: flex; gap: 6px; margin-top: 6px; }
    .btn-yes { background: var(--success-light); color: var(--success); padding: 4px 10px; font-size: 11px; border-radius: 6px; font-weight: 700; }
    .btn-no { background: var(--danger-light); color: var(--danger); padding: 4px 10px; font-size: 11px; border-radius: 6px; font-weight: 700; }
    .outcome-change-badge {
      font-size: 11px; font-weight: 700; padding: 3px 8px; border-radius: 6px; margin-left: 6px;
      font-family: 'JetBrains Mono', monospace;
    }

    .selected-outcome-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      background: var(--accent-light);
      border-radius: 12px;
      margin-bottom: 16px;
      border: 1px solid var(--accent);
    }
    .selected-outcome-header span:first-child {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-primary);
    }
    .selected-outcome-header span:last-child {
      font-size: 18px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }

    .holders-container { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    @media (max-width: 650px) { .holders-container { grid-template-columns: 1fr; } }
    .holders-column-title { 
      font-size: 12px; font-weight: 700; margin-bottom: 12px; 
      padding: 10px 14px; border-radius: 10px;
      display: flex; align-items: center; gap: 6px;
      text-transform: uppercase;
    }
    .holders-column-title.yes { background: var(--success-light); color: var(--success); }
    .holders-column-title.no { background: var(--danger-light); color: var(--danger); }
    .holders-list { display: flex; flex-direction: column; gap: 8px; max-height: 280px; overflow-y: auto; }
    .holder-row { 
      display: flex; align-items: center; gap: 10px; 
      padding: 12px 14px; 
      background: var(--bg-card); 
      border-radius: 12px; 
      cursor: pointer; transition: all 0.2s;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-sm);
    }
    .holder-row:hover { background: var(--bg-hover); transform: translateX(3px); box-shadow: var(--shadow-md); }
    .holder-rank { 
      width: 28px; height: 28px; border-radius: 8px; 
      background: var(--bg-hover); 
      display: flex; align-items: center; justify-content: center; 
      font-size: 12px; font-weight: 700; color: var(--text-secondary);
      flex-shrink: 0;
    }
    .holder-rank.g { background: linear-gradient(135deg, #ffd700, #ffaa00); color: #1a1a2e; box-shadow: 0 2px 4px rgba(255,215,0,0.3); }
    .holder-rank.s { background: linear-gradient(135deg, #e0e0e0, #b0b0b0); color: #1a1a2e; box-shadow: 0 2px 4px rgba(192,192,192,0.3); }
    .holder-rank.b { background: linear-gradient(135deg, #cd7f32, #b5651d); color: #fff; box-shadow: 0 2px 4px rgba(205,127,50,0.3); }
    .holder-info { flex: 1; min-width: 0; }
    .holder-info h4 { font-size: 13px; font-weight: 600; color: var(--text-primary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 120px; }
    .holder-info p { display: none; }
    .holder-right { display: flex; align-items: center; gap: 8px; }
    .holder-amount { font-size: 14px; font-weight: 700; color: var(--text-primary); font-family: 'JetBrains Mono', monospace; }
    .copy-btn { 
      width: 28px; height: 28px; border-radius: 6px;
      background: var(--bg-hover); border: 1px solid var(--border);
      cursor: pointer; font-size: 12px; 
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s; flex-shrink: 0;
    }
    .copy-btn:hover { background: var(--accent-light); border-color: var(--accent); }
    .copy-btn.copied { background: var(--success-light); border-color: var(--success); }

    .profile-header { 
      background: var(--accent-gradient); 
      padding: 32px 24px; 
      color: #fff;
      position: relative;
      overflow: hidden;
    }
    .profile-header::before {
      content: '';
      position: absolute;
      top: -50%; right: -20%;
      width: 200px; height: 200px;
      background: rgba(255,255,255,0.1);
      border-radius: 50%;
    }
    .profile-avatar { 
      width: 64px; height: 64px; border-radius: 16px; 
      background: rgba(255,255,255,0.2); 
      display: flex; align-items: center; justify-content: center; 
      font-size: 28px; font-weight: 700; margin-bottom: 16px;
    }
    .profile-header h2 { font-size: 24px; font-weight: 700; }
    .profile-header p { 
      font-size: 13px; opacity: 0.9; 
      font-family: 'JetBrains Mono', monospace; 
      margin-top: 6px; background: rgba(255,255,255,0.15); 
      padding: 6px 12px; border-radius: 8px; display: inline-block;
    }
    .profile-links { margin-top: 14px; display: flex; gap: 8px; }
    .profile-links a { 
      background: rgba(255,255,255,0.2); color: #fff; 
      padding: 8px 16px; border-radius: 8px; 
      font-size: 12px; text-decoration: none; font-weight: 600; transition: all 0.2s;
    }
    .profile-links a:hover { background: rgba(255,255,255,0.3); }

    .profile-stats { 
      display: grid; grid-template-columns: repeat(2, 1fr); gap: 12px; 
      padding: 20px 24px; background: var(--bg-primary);
    }
    .profile-stat { 
      background: var(--bg-card); 
      padding: 18px; 
      border-radius: 14px; 
      border: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 14px;
    }
    .profile-stat-icon {
      width: 44px; height: 44px;
      border-radius: 12px;
      background: var(--accent-light);
      display: flex; align-items: center; justify-content: center;
      font-size: 20px;
    }
    .profile-stat-icon.success { background: var(--success-light); }
    .profile-stat-icon.purple { background: var(--accent-gradient); }
    .profile-stat-info h4 { font-size: 20px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .profile-stat-info p { font-size: 12px; color: var(--text-secondary); margin-top: 2px; font-weight: 500; }

    .chart-container { 
      padding: 20px 24px; 
      background: var(--bg-card);
    }
    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    .chart-title { font-size: 14px; font-weight: 700; color: var(--text-primary); }
    .chart-value { font-size: 24px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .chart-change { font-size: 13px; font-weight: 600; margin-left: 8px; }
    .chart-filters { display: flex; gap: 6px; }
    .chart-filter-btn {
      padding: 6px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      background: var(--bg-hover);
      border: 1px solid var(--border);
      color: var(--text-secondary);
      cursor: pointer;
      transition: all 0.2s;
      font-family: 'DM Sans', sans-serif;
    }
    .chart-filter-btn:hover { border-color: var(--accent); color: var(--accent); }
    .chart-filter-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .chart-wrapper { height: 180px; position: relative; }

    .tabs { display: flex; border-bottom: 1px solid var(--border); padding: 0 24px; background: var(--bg-card); }
    .tab { 
      padding: 14px 20px; font-size: 13px; font-weight: 600; color: var(--text-secondary); 
      cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; transition: all 0.2s;
    }
    .tab:hover { color: var(--accent); }
    .tab.active { color: var(--accent); border-color: var(--accent); }
    .tab-content { display: none; padding: 20px 24px; max-height: 350px; overflow-y: auto; }
    .tab-content.active { display: block; }

    .position-card { 
      display: flex; align-items: center; gap: 14px; 
      padding: 14px; background: var(--bg-primary); 
      border-radius: 12px; margin-bottom: 10px;
      border: 1px solid var(--border);
    }
    .position-img { width: 44px; height: 44px; border-radius: 10px; background: var(--bg-hover); object-fit: cover; }
    .position-info { flex: 1; min-width: 0; }
    .position-info h4 { font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
    .position-info p { font-size: 11px; color: var(--text-secondary); margin-top: 3px; }
    .position-values { text-align: right; }
    .position-values h4 { font-size: 15px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
    .position-values p { font-size: 12px; margin-top: 3px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }

    .activity-row { 
      display: flex; align-items: center; gap: 12px; 
      padding: 12px 14px; background: var(--bg-primary); 
      border-radius: 10px; margin-bottom: 8px;
      border: 1px solid var(--border);
    }
    .activity-type { padding: 5px 10px; border-radius: 6px; font-size: 10px; font-weight: 700; text-transform: uppercase; }
    .activity-type.buy { background: var(--success-light); color: var(--success); }
    .activity-type.sell { background: var(--danger-light); color: var(--danger); }
    .activity-info { flex: 1; min-width: 0; }
    .activity-info h4 { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; color: var(--text-primary); }
    .activity-info p { font-size: 10px; color: var(--text-muted); }
    .activity-amount { font-weight: 700; font-size: 13px; font-family: 'JetBrains Mono', monospace; }

    .footer { text-align: center; padding: 32px 24px; color: var(--text-muted); font-size: 12px; }
    .footer a { color: var(--accent); text-decoration: none; }

    ::-webkit-scrollbar { width: 5px; height: 5px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }

    /* Watchlist Button */
    .watchlist-btn {
      position: absolute;
      top: 12px;
      right: 12px;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      background: var(--bg-secondary);
      border: 1px solid var(--border);
      cursor: pointer;
      font-size: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 10;
      opacity: 0.7;
    }
    .watchlist-btn:hover { opacity: 1; transform: scale(1.1); }
    .watchlist-btn.active { background: #ffd700; border-color: #ffc107; opacity: 1; }
    .market-card { position: relative; }

    /* Hot/Trending Badge */
    .hot-badge {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 10px;
      font-weight: 700;
      z-index: 10;
    }
    .hot-badge.hot { background: linear-gradient(135deg, #ff6b6b, #ee5a24); color: #fff; }
    .hot-badge.trending { background: linear-gradient(135deg, #10b981, #059669); color: #fff; }
    .hot-badge.ending { background: linear-gradient(135deg, #f59e0b, #d97706); color: #fff; }

    /* Filter Bar */
    .filter-bar {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 16px;
      padding: 14px 18px;
      background: var(--bg-card);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .filter-label {
      font-size: 12px;
      color: var(--text-muted);
      font-weight: 500;
    }
    .filter-select {
      padding: 8px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 13px;
      font-family: 'DM Sans', sans-serif;
      cursor: pointer;
    }
    .filter-select:focus { outline: none; border-color: var(--accent); }
    
    .watchlist-tab {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .watchlist-tab:hover { border-color: var(--accent); }
    .watchlist-tab.active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .watchlist-count {
      background: var(--bg-hover);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 11px;
    }
    .watchlist-tab.active .watchlist-count { background: rgba(255,255,255,0.2); }

    /* Profit Calculator */
    .calc-section {
      margin-top: 20px;
      padding: 16px;
      background: var(--bg-primary);
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .calc-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .calc-inputs {
      display: flex;
      gap: 12px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .calc-input-group {
      flex: 1;
      min-width: 120px;
    }
    .calc-input-group label {
      display: block;
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .calc-input-group input {
      width: 100%;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--bg-secondary);
      color: var(--text-primary);
      font-size: 14px;
      font-family: 'JetBrains Mono', monospace;
    }
    .calc-input-group input:focus { outline: none; border-color: var(--accent); }
    .calc-results {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
    }
    .calc-result {
      padding: 12px;
      border-radius: 8px;
      text-align: center;
    }
    .calc-result.win { background: var(--success-light); }
    .calc-result.lose { background: var(--danger-light); }
    .calc-result-label {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 4px;
    }
    .calc-result-value {
      font-size: 18px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
    }
    .calc-result.win .calc-result-value { color: var(--success); }
    .calc-result.lose .calc-result-value { color: var(--danger); }
    .calc-roi {
      margin-top: 10px;
      padding: 10px;
      background: var(--accent-light);
      border-radius: 8px;
      text-align: center;
    }
    .calc-roi-label { font-size: 11px; color: var(--text-muted); }
    .calc-roi-value { font-size: 16px; font-weight: 700; color: var(--accent); font-family: 'JetBrains Mono', monospace; }

    /* YES/NO Toggle */
    .calc-side-toggle {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 14px;
    }
    .calc-side-btn {
      padding: 12px;
      border-radius: 10px;
      border: 2px solid var(--border);
      background: var(--bg-secondary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
    }
    .calc-side-btn:hover {
      border-color: var(--text-muted);
    }
    .calc-side-btn.active[data-side="yes"] {
      border-color: var(--success);
      background: var(--success-light);
    }
    .calc-side-btn.active[data-side="no"] {
      border-color: var(--danger);
      background: var(--danger-light);
    }
    .calc-side-btn .side-label {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-muted);
    }
    .calc-side-btn.active[data-side="yes"] .side-label { color: var(--success); }
    .calc-side-btn.active[data-side="no"] .side-label { color: var(--danger); }
    .calc-side-btn .side-price {
      font-size: 18px;
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text-primary);
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">P</div>
        <h1>PolyPro<sup>beta</sup></h1>
      </div>
      <div class="header-right">
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle theme">üåô</button>
        <a href="https://polymarket.com" target="_blank" class="btn btn-outline">Open Polymarket ‚Üó</a>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="stats-grid">
      <div class="stat-card"><div class="icon">üìä</div><p>Total Markets</p><h3 id="statCount" class="text-accent">-</h3></div>
      <div class="stat-card"><div class="icon">üí∞</div><p>Total Volume</p><h3 id="statVolume" class="text-success">-</h3></div>
      <div class="stat-card"><div class="icon">üíß</div><p>Total Liquidity</p><h3 id="statLiquidity" class="text-accent">-</h3></div>
      <div class="stat-card"><div class="icon">üìÅ</div><p>Category</p><h3 id="statCategory">All</h3></div>
    </div>

    <div class="categories">
      <button class="cat-btn active" data-tag="all">üåê All</button>
      <button class="cat-btn" data-tag="sports">‚öΩ Sports</button>
      <button class="cat-btn" data-tag="politics">üèõÔ∏è Politics</button>
      <button class="cat-btn" data-tag="crypto">‚Çø Crypto</button>
      <button class="cat-btn" data-tag="entertainment">üé¨ Entertainment</button>
      <button class="cat-btn" data-tag="business">üíº Business</button>
      <button class="cat-btn" data-tag="science">üî¨ Science</button>
    </div>

    <div class="toolbar">
      <div class="search-box"><input type="text" id="search" placeholder="Search markets..."></div>
      <select id="sort">
        <option value="volume">Sort by Volume</option>
        <option value="liquidity">Sort by Liquidity</option>
        <option value="change">Sort by % Change</option>
        <option value="ending">Sort by End Date</option>
      </select>
      <button id="refresh" class="btn btn-primary">‚Üª Refresh</button>
    </div>

    <!-- Filter Bar -->
    <div class="filter-bar">
      <button id="watchlistTab" class="watchlist-tab" onclick="toggleWatchlist()">
        ‚≠ê Watchlist <span class="watchlist-count" id="watchlistCount">0</span>
      </button>
      <div class="filter-group">
        <span class="filter-label">üìÖ Ending:</span>
        <select id="endDateFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All Time</option>
          <option value="today">Today</option>
          <option value="week">This Week</option>
          <option value="month">This Month</option>
        </select>
      </div>
      <div class="filter-group">
        <span class="filter-label">üî• Show:</span>
        <select id="hotFilter" class="filter-select" onchange="applyFilters()">
          <option value="all">All Markets</option>
          <option value="hot">üî• Hot (High Volume)</option>
          <option value="trending">üìà Trending (Big Change)</option>
          <option value="ending">‚è∞ Ending Soon</option>
        </select>
      </div>
    </div>

    <div id="grid" class="markets-grid"><div class="loading"><div class="spinner"></div><p>Loading markets...</p></div></div>

    <div class="pagination" id="pagination" style="display:none">
      <button id="prevBtn">‚Üê Previous</button>
      <span id="pageInfo" style="color:var(--text-secondary);font-size:13px">Page 1</span>
      <button id="nextBtn">Next ‚Üí</button>
    </div>

    <div class="footer">Data from <a href="https://polymarket.com" target="_blank">Polymarket</a> ¬∑ Trading involves risk</div>
  </main>

  <!-- Event Modal -->
  <div id="eventModal" class="modal-overlay">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-header-top">
          <div><h2 id="eventTitle">Event</h2><p id="eventMeta">Category</p></div>
          <button class="close-btn" onclick="closeEvent()">‚úï</button>
        </div>
        <div style="margin-top:12px"><a id="eventLink" href="#" target="_blank" class="btn btn-primary" style="font-size:12px;padding:8px 16px">Open in Polymarket ‚Üó</a></div>
      </div>
      <div class="event-stats">
        <div class="event-stat"><h4 id="eventVolume">$0</h4><p>Volume</p></div>
        <div class="event-stat"><h4 id="eventLiquidity">$0</h4><p>Liquidity</p></div>
        <div class="event-stat"><h4 id="eventOutcomes">0</h4><p>Outcomes</p></div>
        <div class="event-stat"><h4 id="eventComments">0</h4><p>Comments</p></div>
      </div>
      <div class="section">
        <div class="section-header">
          <div class="section-title">üìä Outcomes</div>
          <div class="sort-toggle">
            <button class="sort-btn active" data-sort="chance">% Chance</button>
            <button class="sort-btn" data-sort="change">% Change</button>
          </div>
        </div>
        <div id="outcomesList" class="outcomes-list"></div>
        
        <!-- Market Insights -->
        <div id="marketInsights" class="insights-panel" style="margin-top:20px;"></div>
        
        <!-- Profit Calculator -->
        <div id="profitCalc" class="calc-section" style="display:none;">
          <div class="calc-title">üßÆ Profit Calculator</div>
          <div class="calc-side-toggle">
            <button class="calc-side-btn active" data-side="yes" onclick="setCalcSide('yes')">
              <span class="side-label">YES</span>
              <span class="side-price" id="calcYesPrice">50¬¢</span>
            </button>
            <button class="calc-side-btn" data-side="no" onclick="setCalcSide('no')">
              <span class="side-label">NO</span>
              <span class="side-price" id="calcNoPrice">50¬¢</span>
            </button>
          </div>
          <div class="calc-inputs">
            <div class="calc-input-group">
              <label>Investment ($)</label>
              <input type="number" id="calcAmount" placeholder="100" value="100" oninput="calculateProfit()">
            </div>
            <div class="calc-input-group">
              <label>Buy Price (¬¢)</label>
              <input type="number" id="calcPrice" placeholder="50" oninput="calculateProfit()">
            </div>
          </div>
          <div class="calc-results">
            <div class="calc-result win">
              <div class="calc-result-label" id="calcWinLabel">If YES wins</div>
              <div class="calc-result-value" id="calcWinProfit">+$0</div>
            </div>
            <div class="calc-result lose">
              <div class="calc-result-label" id="calcLoseLabel">If NO wins</div>
              <div class="calc-result-value" id="calcLoseProfit">-$0</div>
            </div>
          </div>
          <div class="calc-roi">
            <div class="calc-roi-label">Potential ROI</div>
            <div class="calc-roi-value" id="calcROI">0%</div>
          </div>
        </div>

        <div id="selectedOutcomeHolders" style="margin-top:20px; display:none;">
          <div class="selected-outcome-header">
            <span id="selectedOutcomeName">-</span>
            <span id="selectedOutcomePrice">-</span>
          </div>
          
          <div id="holdersContainer" class="holders-container">
            <div class="holders-column">
              <div class="holders-column-title yes">‚úÖ YES Top 10</div>
              <div id="yesHoldersList" class="holders-list"></div>
            </div>
            <div class="holders-column">
              <div class="holders-column-title no">‚ùå NO Top 10</div>
              <div id="noHoldersList" class="holders-list"></div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="profile-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="profile-avatar" id="profileAvatar">?</div>
            <h2 id="profileName">Trader</h2>
            <p id="profileWallet">0x...</p>
          </div>
          <button class="close-btn" style="background:rgba(255,255,255,0.2);color:#fff;border:none" onclick="closeProfile()">‚úï</button>
        </div>
        <div class="profile-links">
          <a id="profilePolyLink" href="#" target="_blank">Polymarket ‚Üó</a>
          <a id="profileScanLink" href="#" target="_blank">Polygonscan ‚Üó</a>
        </div>
      </div>
      <div class="profile-stats">
        <div class="profile-stat"><div class="profile-stat-icon">üê∑</div><div class="profile-stat-info"><h4 id="profileValue">$0</h4><p>Positions</p></div></div>
        <div class="profile-stat"><div class="profile-stat-icon success">üíµ</div><div class="profile-stat-info"><h4 id="profilePnl" class="text-success">$0</h4><p>PNL</p></div></div>
        <div class="profile-stat"><div class="profile-stat-icon">üìà</div><div class="profile-stat-info"><h4 id="profileVolume">$0</h4><p>Total Vol</p></div></div>
        <div class="profile-stat"><div class="profile-stat-icon purple">‚ö°</div><div class="profile-stat-info"><h4 id="profileMarkets">0</h4><p>Markets</p></div></div>
      </div>
      <div class="chart-container">
        <div class="chart-header">
          <div><div class="chart-title">PNL</div><div><span id="chartPnlValue" class="chart-value text-success">$0</span><span id="chartPnlChange" class="chart-change text-success">‚Üë $0</span></div></div>
          <div class="chart-filters">
            <button class="chart-filter-btn" data-days="1">1d</button>
            <button class="chart-filter-btn active" data-days="7">7d</button>
            <button class="chart-filter-btn" data-days="30">30d</button>
          </div>
        </div>
        <div class="chart-wrapper"><canvas id="portfolioChart"></canvas></div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="positions">üìä Positions</div>
        <div class="tab" data-tab="activity">üìú Activity</div>
      </div>
      <div id="positionsTab" class="tab-content active"></div>
      <div id="activityTab" class="tab-content"></div>
    </div>
  </div>

  <script>
    const toggleTheme = () => {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('theme', next);
      document.querySelector('.theme-toggle').textContent = next === 'dark' ? '‚òÄÔ∏è' : 'üåô';
      if (portfolioChart) updateChartColors();
    };
    
    const savedTheme = localStorage.getItem('theme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);
    document.querySelector('.theme-toggle').textContent = savedTheme === 'dark' ? '‚òÄÔ∏è' : 'üåô';

    let markets = [], filtered = [], currentTag = 'all', currentPage = 1, totalPages = 1;
    let currentEvent = null, portfolioChart = null, currentProfileData = null;
    let currentConditionId = null;
    let showingWatchlist = false;

    // Watchlist management (localStorage)
    const getWatchlist = () => {
      try {
        return JSON.parse(localStorage.getItem('polymarket_watchlist') || '[]');
      } catch { return []; }
    };
    
    const saveWatchlist = (list) => {
      localStorage.setItem('polymarket_watchlist', JSON.stringify(list));
      updateWatchlistCount();
    };
    
    const isInWatchlist = (slug) => getWatchlist().includes(slug);
    
    const toggleWatchlistItem = (slug, e) => {
      e.stopPropagation();
      const list = getWatchlist();
      const idx = list.indexOf(slug);
      if (idx > -1) {
        list.splice(idx, 1);
      } else {
        list.push(slug);
      }
      saveWatchlist(list);
      renderMarkets();
    };
    
    const updateWatchlistCount = () => {
      document.getElementById('watchlistCount').textContent = getWatchlist().length;
    };
    
    const toggleWatchlist = () => {
      showingWatchlist = !showingWatchlist;
      document.getElementById('watchlistTab').classList.toggle('active', showingWatchlist);
      applyFilters();
    };

    // Check if market is "hot" (high volume relative to avg)
    const isHotMarket = (m) => m.volume > 500000;
    
    // Check if market is "trending" (big price change)
    const isTrendingMarket = (m) => {
      const change = Math.abs(m.outcomes?.[0]?.change || 0);
      return change > 3;
    };
    
    // Check if market is ending soon
    const isEndingSoon = (m, days = 7) => {
      if (!m.endDate) return false;
      const end = new Date(m.endDate);
      const now = new Date();
      const diff = (end - now) / (1000 * 60 * 60 * 24);
      return diff >= 0 && diff <= days;
    };
    
    // Get badge for market
    const getMarketBadge = (m) => {
      if (isEndingSoon(m, 1)) return '<div class="hot-badge ending">‚è∞ Ending Today</div>';
      if (isHotMarket(m)) return '<div class="hot-badge hot">üî• Hot</div>';
      if (isTrendingMarket(m)) return '<div class="hot-badge trending">üìà Trending</div>';
      return '';
    };

    // Profit Calculator
    let calcSide = 'yes';
    let calcYesPrice = 50;
    let calcNoPrice = 50;
    
    const setCalcSide = (side) => {
      calcSide = side;
      document.querySelectorAll('.calc-side-btn').forEach(b => {
        b.classList.toggle('active', b.dataset.side === side);
      });
      // Update price input to selected side's price
      document.getElementById('calcPrice').value = side === 'yes' ? calcYesPrice : calcNoPrice;
      calculateProfit();
    };
    
    const updateCalcPrices = (yesPrice, noPrice) => {
      calcYesPrice = yesPrice;
      calcNoPrice = noPrice;
      document.getElementById('calcYesPrice').textContent = yesPrice + '¬¢';
      document.getElementById('calcNoPrice').textContent = noPrice + '¬¢';
      // Update current price input
      document.getElementById('calcPrice').value = calcSide === 'yes' ? yesPrice : noPrice;
    };

    const calculateProfit = () => {
      const amount = parseFloat(document.getElementById('calcAmount').value) || 0;
      const price = parseFloat(document.getElementById('calcPrice').value) || 0;
      
      if (amount <= 0 || price <= 0 || price >= 100) {
        document.getElementById('calcWinProfit').textContent = '+$0';
        document.getElementById('calcLoseProfit').textContent = '-$0';
        document.getElementById('calcROI').textContent = '0%';
        return;
      }
      
      // Calculate shares bought
      const shares = amount / (price / 100);
      
      // If win: get $1 per share
      const winPayout = shares * 1;
      const winProfit = winPayout - amount;
      
      // If lose: get $0
      const loseProfit = -amount;
      
      // ROI
      const roi = (winProfit / amount) * 100;
      
      // Update labels based on side
      if (calcSide === 'yes') {
        document.getElementById('calcWinLabel').textContent = 'If YES wins';
        document.getElementById('calcLoseLabel').textContent = 'If NO wins';
      } else {
        document.getElementById('calcWinLabel').textContent = 'If NO wins';
        document.getElementById('calcLoseLabel').textContent = 'If YES wins';
      }
      
      document.getElementById('calcWinProfit').textContent = '+$' + winProfit.toFixed(2);
      document.getElementById('calcLoseProfit').textContent = '-$' + amount.toFixed(2);
      document.getElementById('calcROI').textContent = '+' + roi.toFixed(0) + '%';
    };

    const fmt = v => v >= 1e9 ? '$'+(v/1e9).toFixed(2)+'B' : v >= 1e6 ? '$'+(v/1e6).toFixed(2)+'M' : v >= 1e3 ? '$'+(v/1e3).toFixed(1)+'K' : '$'+v.toFixed(0);
    const fmtPnl = v => (v >= 0 ? '+' : '') + fmt(v);
    const fmtShares = v => v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(1)+'K' : v.toFixed(0);
    const fmtChange = v => (v >= 0 ? '+' : '') + v.toFixed(1) + '%';

    const copyWallet = async (wallet, btn) => {
      try {
        await navigator.clipboard.writeText(wallet);
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'üìã';
          btn.classList.remove('copied');
        }, 1500);
      } catch (e) {
        // Fallback for older browsers
        const input = document.createElement('input');
        input.value = wallet;
        document.body.appendChild(input);
        input.select();
        document.execCommand('copy');
        document.body.removeChild(input);
        btn.textContent = '‚úì';
        btn.classList.add('copied');
        setTimeout(() => {
          btn.textContent = 'üìã';
          btn.classList.remove('copied');
        }, 1500);
      }
    };

    const updateStats = (data) => {
      document.getElementById('statCount').textContent = data.pagination?.total || filtered.length;
      document.getElementById('statVolume').textContent = fmt(filtered.reduce((s,m) => s + m.volume, 0));
      document.getElementById('statLiquidity').textContent = fmt(filtered.reduce((s,m) => s + m.liquidity, 0));
      const names = {'all':'All','sports':'Sports','politics':'Politics','crypto':'Crypto','entertainment':'Entertainment','business':'Business','science':'Science'};
      document.getElementById('statCategory').textContent = names[currentTag] || currentTag;
    };

    const renderMarkets = () => {
      const grid = document.getElementById('grid');
      if (!filtered.length) { 
        grid.innerHTML = showingWatchlist 
          ? '<div class="loading">No markets in watchlist<br><small style="color:var(--text-muted)">Click ‚≠ê on any market to add it</small></div>' 
          : '<div class="loading">No markets found</div>'; 
        document.getElementById('pagination').style.display = 'none'; 
        return; 
      }

      grid.innerHTML = filtered.map((m, i) => {
        const rank = ((currentPage - 1) * 100) + i + 1;
        const rc = rank === 1 ? 'r1' : rank === 2 ? 'r2' : rank === 3 ? 'r3' : '';
        const outcomes = m.outcomes || [];
        const inWatchlist = isInWatchlist(m.slug);
        const badge = getMarketBadge(m);
        return `
          <div class="market-card" onclick="openEvent('${m.slug}')">
            ${badge}
            <button class="watchlist-btn ${inWatchlist ? 'active' : ''}" onclick="toggleWatchlistItem('${m.slug}', event)" title="${inWatchlist ? 'Remove from watchlist' : 'Add to watchlist'}">
              ${inWatchlist ? '‚≠ê' : '‚òÜ'}
            </button>
            <div class="market-header">
              <div class="market-rank ${rc}">${rank}</div>
              <img src="${m.image || ''}" class="market-img" onerror="this.style.background='var(--bg-hover)'">
              <div class="market-info">
                <h3>${m.title}</h3>
                <div class="market-tags">${m.tags.slice(0,2).map(t => `<span class="tag">${t}</span>`).join('')}</div>
              </div>
            </div>
            <div class="market-outcomes">
              ${outcomes.slice(0,3).map(o => {
                const change = o.change || 0;
                const changeClass = change > 0 ? 'up' : change < 0 ? 'down' : '';
                return `<div class="outcome-row">
                  <span class="outcome-name">${o.name}</span>
                  <span class="outcome-change ${changeClass}">${fmtChange(change)}</span>
                  <span class="outcome-price ${o.price >= 50 ? 'text-success' : 'text-accent'}">${o.price}%</span>
                  <div class="outcome-bar"><div class="outcome-bar-fill" style="width:${o.price}%"></div></div>
                </div>`;
              }).join('')}
            </div>
            <div class="market-footer">
              <span>üìä ${fmt(m.volume)}</span>
              <span>üíß ${fmt(m.liquidity)}</span>
              ${m.endDate ? `<span>üìÖ ${new Date(m.endDate).toLocaleDateString()}</span>` : ''}
            </div>
          </div>`;
      }).join('');

      const pag = document.getElementById('pagination');
      if (totalPages > 1) { pag.style.display = 'flex'; document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`; document.getElementById('prevBtn').disabled = currentPage <= 1; document.getElementById('nextBtn').disabled = currentPage >= totalPages; } else { pag.style.display = 'none'; }
    };

    const fetchMarkets = async (tag = 'all', page = 1) => {
      currentTag = tag; currentPage = page;
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.tag === tag));
      document.getElementById('grid').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
      try {
        const res = await fetch(`/api/markets?tag=${tag}&page=${page}&limit=100`);
        const json = await res.json();
        if (json.success) { markets = json.data; filtered = markets; totalPages = json.pagination?.totalPages || 1; updateStats(json); applyFilters(); } else throw new Error(json.error);
      } catch (e) { document.getElementById('grid').innerHTML = `<div class="loading">‚ùå ${e.message}</div>`; }
    };

    let searchTimeout = null;
    let isSearching = false;

    const applyFilters = () => {
      const search = document.getElementById('search').value.trim();
      const sort = document.getElementById('sort').value;
      const endDateFilter = document.getElementById('endDateFilter').value;
      const hotFilter = document.getElementById('hotFilter').value;
      
      // Start with all markets or watchlist
      if (showingWatchlist) {
        const watchlist = getWatchlist();
        filtered = markets.filter(m => watchlist.includes(m.slug));
      } else if (!search) {
        filtered = [...markets];
      } else {
        // Filter by search locally
        const searchLower = search.toLowerCase();
        filtered = markets.filter(m => m.title.toLowerCase().includes(searchLower) || m.slug.toLowerCase().includes(searchLower));
      }
      
      // Apply end date filter
      if (endDateFilter !== 'all') {
        const now = new Date();
        filtered = filtered.filter(m => {
          if (!m.endDate) return false;
          const end = new Date(m.endDate);
          const diffDays = (end - now) / (1000 * 60 * 60 * 24);
          if (diffDays < 0) return false;
          if (endDateFilter === 'today') return diffDays <= 1;
          if (endDateFilter === 'week') return diffDays <= 7;
          if (endDateFilter === 'month') return diffDays <= 30;
          return true;
        });
      }
      
      // Apply hot/trending filter
      if (hotFilter !== 'all') {
        filtered = filtered.filter(m => {
          if (hotFilter === 'hot') return isHotMarket(m);
          if (hotFilter === 'trending') return isTrendingMarket(m);
          if (hotFilter === 'ending') return isEndingSoon(m, 7);
          return true;
        });
      }
      
      // Sort
      if (sort === 'liquidity') filtered.sort((a,b) => b.liquidity - a.liquidity);
      else if (sort === 'change') filtered.sort((a,b) => Math.abs(b.outcomes?.[0]?.change || 0) - Math.abs(a.outcomes?.[0]?.change || 0));
      else if (sort === 'ending') filtered.sort((a,b) => {
        if (!a.endDate) return 1;
        if (!b.endDate) return -1;
        return new Date(a.endDate) - new Date(b.endDate);
      });
      else filtered.sort((a,b) => b.volume - a.volume);
      
      // Show results
      if (filtered.length > 0 || showingWatchlist) {
        renderMarkets();
      } else if (search) {
        document.getElementById('grid').innerHTML = `<div class="loading"><div class="spinner"></div><p>Searching all markets for "${search}"...</p></div>`;
      } else {
        renderMarkets();
      }
      
      // Search API with debounce for more results (only if not in watchlist mode)
      if (search.length >= 2 && !showingWatchlist) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => searchAPI(search, sort), 600);
      }
    };

    const searchAPI = async (query, sort) => {
      if (isSearching) return;
      isSearching = true;
      
      // Show loading if no local results
      if (filtered.length === 0) {
        document.getElementById('grid').innerHTML = `<div class="loading"><div class="spinner"></div><p>Searching all markets for "${query}"...</p></div>`;
      }
      
      try {
        const res = await fetch(`/api/search?q=${encodeURIComponent(query)}&limit=50`);
        const json = await res.json();
        
        // Only update if search query hasn't changed
        const currentSearch = document.getElementById('search').value.trim();
        if (currentSearch.toLowerCase() !== query.toLowerCase()) return;
        
        if (json.success && json.data?.length) {
          // Merge with existing results (remove duplicates)
          const existingIds = new Set(filtered.map(m => m.id));
          const newResults = json.data.filter(m => !existingIds.has(m.id));
          
          filtered = [...filtered, ...newResults];
          
          // Re-sort
          if (sort === 'liquidity') filtered.sort((a,b) => b.liquidity - a.liquidity);
          else if (sort === 'change') filtered.sort((a,b) => Math.abs(b.outcomes?.[0]?.change || 0) - Math.abs(a.outcomes?.[0]?.change || 0));
          else filtered.sort((a,b) => b.volume - a.volume);
          
          renderMarkets();
        } else if (filtered.length === 0) {
          // No results found anywhere
          document.getElementById('grid').innerHTML = `<div class="loading"><p>No markets found for "${query}"</p><p style="font-size:12px;margin-top:8px;color:var(--text-muted)">Try a different search term</p></div>`;
        }
      } catch (e) {
        console.error('Search API error:', e);
        if (filtered.length === 0) {
          document.getElementById('grid').innerHTML = `<div class="loading"><p>No markets found for "${query}"</p></div>`;
        }
      } finally {
        isSearching = false;
      }
    };

    let currentOutcomeSort = 'chance'; // Default to % Chance (like Polymarket)

    const openEvent = async (slug) => {
      document.getElementById('eventModal').classList.add('active');
      document.getElementById('outcomesList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('selectedOutcomeHolders').style.display = 'none';
      document.getElementById('marketInsights').innerHTML = '';
      document.getElementById('profitCalc').style.display = 'none';
      currentOutcomeSort = 'chance'; // Reset to default
      currentConditionId = null;
      
      // Reset sort buttons
      document.querySelectorAll('.sort-btn').forEach(b => b.classList.toggle('active', b.dataset.sort === 'chance'));
      
      try {
        const res = await fetch(`/api/event?slug=${encodeURIComponent(slug)}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);
        currentEvent = json.data;
        document.getElementById('eventTitle').textContent = currentEvent.title;
        document.getElementById('eventMeta').textContent = `${currentEvent.category} ¬∑ ${currentEvent.endDate ? 'Ends ' + new Date(currentEvent.endDate).toLocaleDateString() : ''}`;
        document.getElementById('eventVolume').textContent = fmt(currentEvent.volume);
        document.getElementById('eventLiquidity').textContent = fmt(currentEvent.liquidity);
        document.getElementById('eventOutcomes').textContent = currentEvent.outcomes.length;
        document.getElementById('eventComments').textContent = currentEvent.commentCount;
        document.getElementById('eventLink').href = `https://polymarket.com/event/${slug}`;

        if (currentEvent.outcomes?.length) {
          renderOutcomes(currentOutcomeSort);
          generateMarketInsights();
        } else { 
          document.getElementById('outcomesList').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px">No outcomes</p>'; 
        }
      } catch (e) { document.getElementById('outcomesList').innerHTML = `<p style="color:var(--danger);padding:20px">${e.message}</p>`; }
    };

    const renderOutcomes = (sortBy) => {
      if (!currentEvent?.outcomes?.length) return;
      
      let sorted = [...currentEvent.outcomes];
      if (sortBy === 'chance') {
        // Sort by % Chance (price) - highest first (like Polymarket)
        sorted.sort((a, b) => b.yesPrice - a.yesPrice);
      } else {
        // Sort by % Change (absolute) - most volatile first
        sorted.sort((a, b) => Math.abs(b.change24h || 0) - Math.abs(a.change24h || 0));
      }

      document.getElementById('outcomesList').innerHTML = sorted.map((o, i) => {
        const change = o.change24h || 0;
        const changeClass = change > 0 ? 'text-success' : change < 0 ? 'text-danger' : '';
        const changeBg = change > 0 ? 'background:var(--success-light)' : change < 0 ? 'background:var(--danger-light)' : '';
        const escapedName = (o.name || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
        return `<div class="outcome-card ${i === 0 ? 'selected' : ''}" onclick="selectOutcome('${o.conditionId}', this, '${escapedName}', ${o.yesPrice}, ${o.noPrice})">
          <div class="outcome-num ${i === 0 ? 'top' : ''}">${i + 1}</div>
          <div class="outcome-details"><h4>${o.name}</h4><p>Vol: ${fmt(o.volume)} ¬∑ Liq: ${fmt(o.liquidity)}</p></div>
          <div class="outcome-price-box">
            <h4 class="${o.yesPrice >= 50 ? 'text-success' : 'text-danger'}">${o.yesPrice}%</h4>
            <span class="outcome-change-badge ${changeClass}" style="${changeBg}">${fmtChange(change)}</span>
            <div class="outcome-btns"><span class="btn-yes">Yes ${o.yesPrice}¬¢</span><span class="btn-no">No ${o.noPrice}¬¢</span></div>
          </div>
        </div>`;
      }).join('');
      
      // Auto-select first outcome
      if (sorted[0]?.conditionId) { 
        currentConditionId = sorted[0].conditionId;
        document.getElementById('selectedOutcomeName').textContent = sorted[0].name || 'Selected'; 
        document.getElementById('selectedOutcomePrice').textContent = `${sorted[0].yesPrice}%`; 
        document.getElementById('selectedOutcomePrice').className = sorted[0].yesPrice >= 50 ? 'text-success' : 'text-danger'; 
        loadHolders(sorted[0].conditionId);
        
        // Update profit calculator with first outcome prices
        document.getElementById('profitCalc').style.display = 'block';
        calcSide = 'yes'; // Reset to YES
        document.querySelectorAll('.calc-side-btn').forEach(b => b.classList.toggle('active', b.dataset.side === 'yes'));
        updateCalcPrices(sorted[0].yesPrice, sorted[0].noPrice);
        calculateProfit();
      }
    };

    const generateMarketInsights = () => {
      if (!currentEvent) return;
      const outcomes = currentEvent.outcomes || [];
      if (!outcomes.length) return;
      
      // Calculate insights
      const top = outcomes.reduce((a, b) => a.yesPrice > b.yesPrice ? a : b);
      const totalVol = currentEvent.volume || 0;
      const totalLiq = currentEvent.liquidity || 0;
      const volLiqRatio = totalLiq > 0 ? (totalVol / totalLiq).toFixed(1) : 0;
      
      // Whale concentration (top 3 outcomes % of total volume)
      const sortedByVol = [...outcomes].sort((a, b) => b.volume - a.volume);
      const top3Vol = sortedByVol.slice(0, 3).reduce((s, o) => s + o.volume, 0);
      const concentration = totalVol > 0 ? Math.round((top3Vol / totalVol) * 100) : 0;
      
      // Volatility (average absolute change)
      const avgChange = outcomes.reduce((s, o) => s + Math.abs(o.change24h || 0), 0) / outcomes.length;
      const volatility = avgChange > 5 ? 'High' : avgChange > 2 ? 'Medium' : 'Low';
      const volColor = avgChange > 5 ? 'text-danger' : avgChange > 2 ? 'text-accent' : 'text-success';
      
      // Sentiment (YES vs NO distribution based on price)
      const avgPrice = outcomes.reduce((s, o) => s + o.yesPrice, 0) / outcomes.length;
      const sentiment = avgPrice > 50 ? 'Bullish' : avgPrice < 30 ? 'Bearish' : 'Neutral';
      const sentColor = avgPrice > 50 ? 'text-success' : avgPrice < 30 ? 'text-danger' : 'text-secondary';
      
      document.getElementById('marketInsights').innerHTML = `
        <div class="insights-title">üí° Market Insights</div>
        <div class="insights-grid">
          <div class="insight-item">
            <div class="label">Leading Outcome</div>
            <div class="value text-accent">${top.name}</div>
            <div class="hint">${top.yesPrice}% chance</div>
          </div>
          <div class="insight-item">
            <div class="label">Vol/Liq Ratio</div>
            <div class="value">${volLiqRatio}x</div>
            <div class="hint">${volLiqRatio > 10 ? 'High activity' : 'Normal activity'}</div>
          </div>
          <div class="insight-item">
            <div class="label">Volatility (24h)</div>
            <div class="value ${volColor}">${volatility}</div>
            <div class="hint">Avg change: ${avgChange.toFixed(1)}%</div>
          </div>
          <div class="insight-item">
            <div class="label">Concentration</div>
            <div class="value">${concentration}%</div>
            <div class="hint">Top 3 outcomes</div>
          </div>
          <div class="insight-item">
            <div class="label">Market Sentiment</div>
            <div class="value ${sentColor}">${sentiment}</div>
            <div class="hint">Based on pricing</div>
          </div>
          <div class="insight-item">
            <div class="label">Outcomes</div>
            <div class="value">${outcomes.length}</div>
            <div class="hint">${outcomes.length > 10 ? 'Many options' : 'Few options'}</div>
          </div>
        </div>
      `;
    };

    const selectOutcome = (conditionId, el, name, yesPrice, noPrice) => {
      document.querySelectorAll('.outcome-card').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      document.getElementById('selectedOutcomeName').textContent = name || 'Selected';
      document.getElementById('selectedOutcomePrice').textContent = yesPrice ? `${yesPrice}%` : '-';
      document.getElementById('selectedOutcomePrice').className = yesPrice >= 50 ? 'text-success' : 'text-danger';
      
      currentConditionId = conditionId;
      loadHolders(conditionId);
      
      // Show and update profit calculator
      document.getElementById('profitCalc').style.display = 'block';
      calcSide = 'yes'; // Reset to YES when selecting new outcome
      document.querySelectorAll('.calc-side-btn').forEach(b => b.classList.toggle('active', b.dataset.side === 'yes'));
      updateCalcPrices(yesPrice || 50, noPrice || 50);
      calculateProfit();
    };

    const loadHolders = async (conditionId) => {
      document.getElementById('selectedOutcomeHolders').style.display = 'block';
      document.getElementById('yesHoldersList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('noHoldersList').innerHTML = '';
      try {
        const res = await fetch(`/api/holders?market=${conditionId}&limit=50`);
        const json = await res.json();
        if (json.success && json.data?.length) {
          const yesH = json.data.filter(h => h.outcome === 'YES');
          const noH = json.data.filter(h => h.outcome === 'NO');
          
          const renderHL = (holders, maxItems = 10) => {
            // Ensure we always show exactly maxItems (pad with empty if needed)
            const items = holders.slice(0, maxItems);
            return items.map((h, i) => {
              const rc = i === 0 ? 'g' : i === 1 ? 's' : i === 2 ? 'b' : '';
              // Ensure short display name
              let shortName = h.displayName || '';
              if (shortName.length > 16) {
                shortName = shortName.slice(0, 14) + '...';
              }
              const escapedName = shortName.replace(/'/g, "\\'");
              return `<div class="holder-row" onclick="openProfile('${h.wallet}', '${escapedName}')">
                <div class="holder-rank ${rc}">${i + 1}</div>
                <div class="holder-info"><h4 title="${h.displayName}">${shortName}</h4></div>
                <div class="holder-right">
                  <span class="holder-amount">${fmtShares(h.amount)}</span>
                  <button class="copy-btn" onclick="event.stopPropagation(); copyWallet('${h.wallet}', this)" title="Copy wallet">üìã</button>
                </div>
              </div>`;
            }).join('');
          };
          
          document.getElementById('yesHoldersList').innerHTML = yesH.length > 0 ? renderHL(yesH, 10) : '<p style="color:var(--text-muted);text-align:center;padding:16px">No YES holders</p>';
          document.getElementById('noHoldersList').innerHTML = noH.length > 0 ? renderHL(noH, 10) : '<p style="color:var(--text-muted);text-align:center;padding:16px">No NO holders</p>';
        } else { document.getElementById('yesHoldersList').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:16px">No data</p>'; }
      } catch (e) { document.getElementById('yesHoldersList').innerHTML = `<p style="color:var(--text-muted);padding:16px">${e.message}</p>`; }
    };

    const closeEvent = () => { document.getElementById('eventModal').classList.remove('active'); currentEvent = null; };

    const openProfile = async (wallet, name) => {
      document.getElementById('profileModal').classList.add('active');
      document.getElementById('profileName').textContent = name || 'Trader';
      document.getElementById('profileWallet').textContent = `${wallet.slice(0,6)}...${wallet.slice(-4)}`;
      document.getElementById('profileAvatar').textContent = (name || wallet).charAt(0).toUpperCase();
      document.getElementById('profilePolyLink').href = `https://polymarket.com/profile/${wallet}`;
      document.getElementById('profileScanLink').href = `https://polygonscan.com/address/${wallet}`;
      document.getElementById('positionsTab').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('activityTab').innerHTML = '';
      if (portfolioChart) { portfolioChart.destroy(); portfolioChart = null; }
      try {
        const res = await fetch(`/api/profile?wallet=${wallet}`);
        const json = await res.json();
        if (json.success) {
          currentProfileData = json.data;
          const d = json.data, s = d.stats;
          document.getElementById('profileValue').textContent = fmt(s.portfolioValue);
          document.getElementById('profilePnl').textContent = fmtPnl(s.totalPnl);
          document.getElementById('profilePnl').className = s.totalPnl >= 0 ? 'text-success' : 'text-danger';
          document.getElementById('profileVolume').textContent = fmt(s.totalVolume);
          document.getElementById('profileMarkets').textContent = s.marketsCount;
          document.getElementById('chartPnlValue').textContent = fmtPnl(s.totalPnl);
          document.getElementById('chartPnlValue').className = 'chart-value ' + (s.totalPnl >= 0 ? 'text-success' : 'text-danger');
          const last7 = d.pnlHistory?.slice(-7) || [];
          const pnl7 = last7.reduce((sum, h) => sum + h.pnl, 0);
          document.getElementById('chartPnlChange').textContent = (pnl7 >= 0 ? '‚Üë ' : '‚Üì ') + fmt(Math.abs(pnl7));
          document.getElementById('chartPnlChange').className = 'chart-change ' + (pnl7 >= 0 ? 'text-success' : 'text-danger');
          if (d.pnlHistory?.length) renderPortfolioChart(d.pnlHistory, 7);
          if (d.positions?.length) { document.getElementById('positionsTab').innerHTML = d.positions.map(p => `<div class="position-card"><img src="${p.image || ''}" class="position-img" onerror="this.style.background='var(--bg-hover)'"><div class="position-info"><h4>${p.market}</h4><p>${p.outcome} ¬∑ ${Math.round(p.avgPrice * 100)}¬¢ ‚Üí ${Math.round(p.currentPrice * 100)}¬¢</p></div><div class="position-values"><h4>${fmt(p.currentValue)}</h4><p class="${p.pnl >= 0 ? 'text-success' : 'text-danger'}">${fmtPnl(p.pnl)}</p></div></div>`).join(''); } else { document.getElementById('positionsTab').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px">No positions</p>'; }
          if (d.recentActivity?.length) { document.getElementById('activityTab').innerHTML = d.recentActivity.map(a => `<div class="activity-row"><span class="activity-type ${a.side?.toLowerCase()}">${a.side || a.type}</span><div class="activity-info"><h4>${a.market}</h4><p>${a.outcome} @ ${Math.round(a.price * 100)}¬¢</p></div><div class="activity-amount">${fmt(a.usdcSize || a.size)}</div></div>`).join(''); } else { document.getElementById('activityTab').innerHTML = '<p style="color:var(--text-muted);text-align:center;padding:20px">No activity</p>'; }
        }
      } catch (e) { document.getElementById('positionsTab').innerHTML = `<p style="color:var(--danger);padding:20px">${e.message}</p>`; }
    };

    const getChartColors = () => {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      return { line: '#7c5cff', fill: isDark ? 'rgba(124, 92, 255, 0.15)' : 'rgba(124, 92, 255, 0.1)', grid: isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)', text: isDark ? '#9999b0' : '#6b7280' };
    };
    const updateChartColors = () => { if (!portfolioChart) return; const c = getChartColors(); portfolioChart.data.datasets[0].borderColor = c.line; portfolioChart.data.datasets[0].backgroundColor = c.fill; portfolioChart.options.scales.x.grid.color = c.grid; portfolioChart.options.scales.y.grid.color = c.grid; portfolioChart.options.scales.x.ticks.color = c.text; portfolioChart.options.scales.y.ticks.color = c.text; portfolioChart.update(); };
    const renderPortfolioChart = (history, days = 7) => {
      const ctx = document.getElementById('portfolioChart').getContext('2d');
      const colors = getChartColors();
      const sliced = history.slice(-days);
      let cum = 0;
      const values = sliced.map(h => { cum += h.pnl; return cum; });
      if (portfolioChart) portfolioChart.destroy();
      portfolioChart = new Chart(ctx, { type: 'line', data: { labels: sliced.map(h => h.date.slice(5)), datasets: [{ label: 'PNL', data: values, borderColor: colors.line, backgroundColor: colors.fill, fill: true, tension: 0.4, pointRadius: 0, pointHoverRadius: 5, borderWidth: 2 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1a1a25', titleColor: '#fff', bodyColor: '#9999b0', padding: 10, displayColors: false, callbacks: { label: (ctx) => '$' + ctx.raw.toFixed(2) } } }, scales: { x: { display: true, grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.text, maxTicksLimit: 5, font: { family: 'JetBrains Mono', size: 10 } } }, y: { display: true, grid: { color: colors.grid, drawBorder: false }, ticks: { color: colors.text, font: { family: 'JetBrains Mono', size: 10 }, callback: (v) => '$' + v.toFixed(0) } } }, interaction: { intersect: false, mode: 'index' } } });
    };
    const closeProfile = () => { document.getElementById('profileModal').classList.remove('active'); if (portfolioChart) { portfolioChart.destroy(); portfolioChart = null; } };

    document.querySelectorAll('.chart-filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.chart-filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        const days = parseInt(btn.dataset.days);
        if (currentProfileData?.pnlHistory) {
          renderPortfolioChart(currentProfileData.pnlHistory, days);
          const sliced = currentProfileData.pnlHistory.slice(-days);
          const pnlP = sliced.reduce((sum, h) => sum + h.pnl, 0);
          document.getElementById('chartPnlChange').textContent = (pnlP >= 0 ? '‚Üë ' : '‚Üì ') + fmt(Math.abs(pnlP));
          document.getElementById('chartPnlChange').className = 'chart-change ' + (pnlP >= 0 ? 'text-success' : 'text-danger');
        }
      });
    });

    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });

    // Sort toggle for outcomes
    document.querySelectorAll('.sort-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.sort-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentOutcomeSort = btn.dataset.sort;
        renderOutcomes(currentOutcomeSort);
      });
    });

    document.getElementById('eventModal').addEventListener('click', closeEvent);
    document.getElementById('profileModal').addEventListener('click', closeProfile);
    document.querySelectorAll('.cat-btn').forEach(b => b.addEventListener('click', () => { showingWatchlist = false; document.getElementById('watchlistTab').classList.remove('active'); fetchMarkets(b.dataset.tag, 1); }));
    document.getElementById('search').addEventListener('input', applyFilters);
    document.getElementById('sort').addEventListener('change', applyFilters);
    document.getElementById('refresh').addEventListener('click', () => fetchMarkets(currentTag, currentPage));
    document.getElementById('prevBtn').addEventListener('click', () => { if (currentPage > 1) fetchMarkets(currentTag, currentPage - 1); });
    document.getElementById('nextBtn').addEventListener('click', () => { if (currentPage < totalPages) fetchMarkets(currentTag, currentPage + 1); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeEvent(); closeProfile(); } });

    // Initialize watchlist count
    updateWatchlistCount();
    
    fetchMarkets('all', 1);
  </script>
</body>
</html>
