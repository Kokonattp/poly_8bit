<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolyMarket Pro - Top 200 Markets</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; }
    body { background: #0a0a0a; color: #fff; min-height: 100vh; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #111; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    .header { border-bottom: 1px solid #1a1a1a; padding: 14px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: rgba(10,10,10,0.95); backdrop-filter: blur(10px); z-index: 40; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 38px; height: 38px; border-radius: 10px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 16px; }
    .logo h1 { font-size: 17px; font-weight: 600; }
    .logo p { font-size: 11px; color: #666; }
    .header-right { display: flex; gap: 12px; align-items: center; }
    .btn { padding: 9px 18px; border-radius: 8px; font-weight: 500; font-size: 13px; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
    .btn-ghost { background: transparent; border: 1px solid #2a2a2a; color: #999; }
    .btn-ghost:hover { background: #1a1a1a; color: #fff; }
    .btn-primary { background: #8b5cf6; color: #fff; }
    .btn-primary:hover { background: #7c3aed; }
    .status { padding: 6px 12px; border-radius: 6px; font-size: 12px; display: flex; align-items: center; gap: 6px; background: rgba(0,210,106,0.1); color: #00d26a; }
    .status.error { background: rgba(255,71,87,0.1); color: #ff4757; }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }

    .main { max-width: 1440px; margin: 0 auto; padding: 20px; }
    
    .stats-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; margin-bottom: 20px; }
    @media (max-width: 768px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }
    .stat { background: #111; border: 1px solid #1a1a1a; border-radius: 10px; padding: 16px; }
    .stat p { color: #666; font-size: 12px; margin-bottom: 4px; }
    .stat h3 { font-size: 22px; font-weight: 600; }
    .text-purple { color: #8b5cf6; }
    .text-green { color: #00d26a; }
    .text-red { color: #ff4757; }

    .categories { display: flex; gap: 6px; flex-wrap: wrap; margin-bottom: 16px; }
    .cat-btn { padding: 8px 16px; border-radius: 6px; font-size: 13px; font-weight: 500; background: #151515; border: 1px solid #222; color: #777; cursor: pointer; transition: all 0.15s; }
    .cat-btn:hover { border-color: #8b5cf6; color: #ccc; }
    .cat-btn.active { background: #8b5cf6; border-color: #8b5cf6; color: #fff; }

    .toolbar { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 200px; }
    .search-box input { width: 100%; padding: 10px 14px 10px 38px; background: #111; border: 1px solid #1a1a1a; border-radius: 8px; color: #fff; font-size: 13px; outline: none; background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%23666'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: 12px center; background-size: 16px; }
    .search-box input:focus { border-color: #8b5cf6; }
    select { padding: 10px 14px; background: #111; border: 1px solid #1a1a1a; border-radius: 8px; color: #fff; font-size: 13px; cursor: pointer; }

    .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 12px; }
    .card { background: #111; border: 1px solid #1a1a1a; border-radius: 12px; overflow: hidden; cursor: pointer; transition: all 0.2s; position: relative; }
    .card:hover { border-color: #333; transform: translateY(-2px); }
    .card-rank { position: absolute; top: 10px; left: 10px; width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; background: #222; color: #666; z-index: 2; }
    .card-rank.r1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .card-rank.r2 { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #000; }
    .card-rank.r3 { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
    .card-header { display: flex; gap: 12px; padding: 14px; }
    .card-img { width: 52px; height: 52px; border-radius: 8px; object-fit: cover; background: #1a1a1a; flex-shrink: 0; }
    .card-info { flex: 1; min-width: 0; }
    .card-info h3 { font-size: 13px; font-weight: 500; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .card-meta { display: flex; gap: 6px; margin-top: 6px; flex-wrap: wrap; }
    .tag { font-size: 10px; padding: 3px 7px; background: #1a1a1a; border-radius: 4px; color: #888; }
    .card-body { padding: 0 14px 14px; }
    .outcomes-preview { display: flex; flex-direction: column; gap: 6px; margin-bottom: 10px; }
    .outcome-row { display: flex; align-items: center; gap: 8px; font-size: 12px; }
    .outcome-name { flex: 1; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .outcome-pct { font-weight: 600; min-width: 40px; text-align: right; }
    .outcome-bar { flex: 1; max-width: 80px; height: 4px; background: #1a1a1a; border-radius: 2px; overflow: hidden; }
    .outcome-bar-fill { height: 100%; background: linear-gradient(90deg, #8b5cf6, #3b82f6); border-radius: 2px; }
    .card-stats { display: flex; justify-content: space-between; font-size: 11px; color: #666; padding-top: 10px; border-top: 1px solid #1a1a1a; }

    .loading { text-align: center; padding: 60px; color: #666; grid-column: 1/-1; }
    .spinner { width: 28px; height: 28px; border: 2px solid #222; border-top-color: #8b5cf6; border-radius: 50%; animation: spin 0.7s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal Base */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); backdrop-filter: blur(4px); z-index: 100; display: none; overflow-y: auto; padding: 3vh 16px; }
    .modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }
    .modal { background: #111; border: 1px solid #222; border-radius: 14px; width: 100%; max-width: 800px; overflow: hidden; }
    .modal-header { padding: 18px 20px; border-bottom: 1px solid #1a1a1a; display: flex; justify-content: space-between; gap: 16px; }
    .modal-header-info h2 { font-size: 16px; font-weight: 600; line-height: 1.4; }
    .modal-header-info p { font-size: 12px; color: #666; margin-top: 4px; }
    .modal-header-info .links { display: flex; gap: 8px; margin-top: 10px; }
    .close-btn { width: 32px; height: 32px; border-radius: 8px; background: #1a1a1a; border: none; color: #666; cursor: pointer; font-size: 16px; flex-shrink: 0; }
    .close-btn:hover { background: #222; color: #fff; }

    /* Event Modal */
    .event-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #1a1a1a; }
    .event-stat { background: #111; padding: 14px; text-align: center; }
    .event-stat h4 { font-size: 18px; font-weight: 600; }
    .event-stat p { font-size: 11px; color: #666; margin-top: 2px; }
    .modal-section { padding: 18px 20px; border-bottom: 1px solid #1a1a1a; }
    .modal-section:last-child { border-bottom: none; }
    .modal-section h3 { font-size: 13px; font-weight: 600; margin-bottom: 14px; display: flex; align-items: center; gap: 8px; }
    
    .outcomes-list { display: flex; flex-direction: column; gap: 8px; max-height: 300px; overflow-y: auto; }
    .outcome-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: #151515; border: 1px solid #1a1a1a; border-radius: 8px; }
    .outcome-card:hover { border-color: #333; }
    .outcome-rank { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; background: #1a1a1a; color: #666; }
    .outcome-rank.top { background: linear-gradient(135deg, #8b5cf6, #3b82f6); color: #fff; }
    .outcome-details { flex: 1; min-width: 0; }
    .outcome-details h4 { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .outcome-details p { font-size: 11px; color: #666; margin-top: 2px; }
    .outcome-price { text-align: right; }
    .outcome-price h4 { font-size: 16px; font-weight: 600; }
    .outcome-price p { font-size: 11px; margin-top: 2px; }
    .btn-yes { background: rgba(0,210,106,0.15); color: #00d26a; }
    .btn-no { background: rgba(255,71,87,0.15); color: #ff4757; }

    .holders-list { display: flex; flex-direction: column; gap: 6px; max-height: 280px; overflow-y: auto; }
    .holder-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #151515; border-radius: 8px; cursor: pointer; transition: all 0.15s; }
    .holder-row:hover { background: #1a1a1a; }
    .holder-rank { width: 24px; height: 24px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 600; background: #1a1a1a; color: #666; flex-shrink: 0; }
    .holder-rank.g { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .holder-rank.s { background: linear-gradient(135deg, #9ca3af, #6b7280); color: #000; }
    .holder-rank.b { background: linear-gradient(135deg, #d97706, #b45309); color: #fff; }
    .holder-info { flex: 1; min-width: 0; }
    .holder-info h4 { font-size: 13px; font-weight: 500; }
    .holder-info p { font-size: 10px; color: #666; font-family: monospace; }
    .holder-pos { text-align: right; }
    .holder-pos h4 { font-size: 13px; font-weight: 500; }
    .holder-pos .badge { font-size: 10px; padding: 2px 6px; border-radius: 4px; margin-top: 2px; display: inline-block; }
    .badge-yes { background: rgba(0,210,106,0.15); color: #00d26a; }
    .badge-no { background: rgba(255,71,87,0.15); color: #ff4757; }

    /* Profile Modal */
    .profile-header { display: flex; align-items: center; gap: 16px; padding: 20px; border-bottom: 1px solid #1a1a1a; }
    .profile-avatar { width: 56px; height: 56px; border-radius: 12px; background: linear-gradient(135deg, #8b5cf6, #3b82f6); display: flex; align-items: center; justify-content: center; font-size: 22px; font-weight: 600; }
    .profile-info h2 { font-size: 18px; font-weight: 600; }
    .profile-info p { font-size: 12px; color: #666; font-family: monospace; margin-top: 4px; }
    .profile-info .links { margin-top: 8px; }
    .profile-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #1a1a1a; }
    .profile-stat { background: #111; padding: 14px; text-align: center; }
    .profile-stat h4 { font-size: 18px; font-weight: 600; }
    .profile-stat p { font-size: 10px; color: #666; margin-top: 2px; }
    
    .tabs { display: flex; gap: 4px; padding: 0 20px; border-bottom: 1px solid #1a1a1a; }
    .tab { padding: 12px 16px; font-size: 13px; font-weight: 500; color: #666; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -1px; }
    .tab:hover { color: #999; }
    .tab.active { color: #fff; border-color: #8b5cf6; }
    .tab-content { display: none; padding: 16px 20px; max-height: 350px; overflow-y: auto; }
    .tab-content.active { display: block; }
    
    .position-card { display: flex; align-items: center; gap: 12px; padding: 12px; background: #151515; border: 1px solid #1a1a1a; border-radius: 8px; margin-bottom: 8px; }
    .position-card:hover { border-color: #333; }
    .position-img { width: 40px; height: 40px; border-radius: 6px; background: #1a1a1a; object-fit: cover; }
    .position-info { flex: 1; min-width: 0; }
    .position-info h4 { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .position-info p { font-size: 10px; color: #666; margin-top: 2px; }
    .position-values { text-align: right; }
    .position-values h4 { font-size: 13px; font-weight: 500; }
    .position-values p { font-size: 11px; margin-top: 2px; }

    .activity-row { display: flex; align-items: center; gap: 10px; padding: 10px 12px; background: #151515; border-radius: 8px; margin-bottom: 6px; font-size: 12px; }
    .activity-type { padding: 4px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; background: #1a1a1a; color: #888; }
    .activity-type.buy { background: rgba(0,210,106,0.15); color: #00d26a; }
    .activity-type.sell { background: rgba(255,71,87,0.15); color: #ff4757; }
    .activity-info { flex: 1; min-width: 0; }
    .activity-info h4 { font-size: 12px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .activity-info p { font-size: 10px; color: #666; }
    .activity-amount { text-align: right; font-weight: 500; }

    .footer { margin-top: 32px; padding: 20px 0; border-top: 1px solid #1a1a1a; text-align: center; color: #666; font-size: 12px; }
    .footer a { color: #8b5cf6; text-decoration: none; }

    @media (max-width: 640px) {
      .grid { grid-template-columns: 1fr; }
      .event-stats, .profile-stats { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body>
  <header class="header">
    <div class="logo">
      <div class="logo-icon">P</div>
      <div>
        <h1>PolyMarket Pro</h1>
        <p>Top 200 Markets by Category</p>
      </div>
    </div>
    <div class="header-right">
      <a href="https://polymarket.com" target="_blank" class="btn btn-ghost">Open Polymarket ‚Üó</a>
      <div id="status" class="status"><div class="status-dot"></div><span>Loading...</span></div>
    </div>
  </header>

  <main class="main">
    <div class="stats-row">
      <div class="stat"><p>Total Markets</p><h3 id="statCount">-</h3></div>
      <div class="stat"><p>Total Volume</p><h3 id="statVolume" class="text-purple">-</h3></div>
      <div class="stat"><p>Total Liquidity</p><h3 id="statLiquidity" class="text-green">-</h3></div>
      <div class="stat"><p>Category</p><h3 id="statCategory">All</h3></div>
    </div>

    <div class="categories" id="categories">
      <button class="cat-btn active" data-tag="all">üåê All</button>
      <button class="cat-btn" data-tag="sports">‚öΩ Sports</button>
      <button class="cat-btn" data-tag="politics">üèõÔ∏è Politics</button>
      <button class="cat-btn" data-tag="crypto">‚Çø Crypto</button>
      <button class="cat-btn" data-tag="pop-culture">üé¨ Culture</button>
      <button class="cat-btn" data-tag="business">üíº Business</button>
      <button class="cat-btn" data-tag="nfl">üèà NFL</button>
      <button class="cat-btn" data-tag="nba">üèÄ NBA</button>
      <button class="cat-btn" data-tag="soccer">‚öΩ Soccer</button>
      <button class="cat-btn" data-tag="mma">ü•ä MMA</button>
    </div>

    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="search" placeholder="Search markets...">
      </div>
      <select id="sort">
        <option value="volume">Sort by Volume</option>
        <option value="liquidity">Sort by Liquidity</option>
        <option value="outcomes">Sort by Outcomes</option>
      </select>
      <button id="refresh" class="btn btn-primary">‚Üª Refresh</button>
    </div>

    <div class="grid" id="grid">
      <div class="loading"><div class="spinner"></div><p>Loading markets...</p></div>
    </div>

    <div class="footer">Data from <a href="https://polymarket.com" target="_blank">Polymarket</a> ¬∑ Trading involves risk ¬∑ Not financial advice</div>
  </main>

  <!-- Event Modal -->
  <div id="eventModal" class="modal-overlay" onclick="closeEventModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-header-info">
          <h2 id="eventTitle">Event Title</h2>
          <p id="eventCategory">Category ¬∑ End Date</p>
          <div class="links">
            <a id="eventLink" href="#" target="_blank" class="btn btn-ghost">Open in Polymarket ‚Üó</a>
          </div>
        </div>
        <button class="close-btn" onclick="closeEventModal()">‚úï</button>
      </div>
      <div class="event-stats">
        <div class="event-stat"><h4 id="eventVolume">$0</h4><p>Volume</p></div>
        <div class="event-stat"><h4 id="eventLiquidity">$0</h4><p>Liquidity</p></div>
        <div class="event-stat"><h4 id="eventOutcomes">0</h4><p>Outcomes</p></div>
        <div class="event-stat"><h4 id="eventEnd">-</h4><p>End Date</p></div>
      </div>
      <div class="modal-section">
        <h3>üìä All Outcomes / Teams</h3>
        <div id="outcomesList" class="outcomes-list"></div>
      </div>
      <div class="modal-section">
        <h3>üèÜ Top Traders / Holders</h3>
        <div id="holdersList" class="holders-list"></div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay" onclick="closeProfileModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="profile-header">
        <div class="profile-avatar" id="profileAvatar">?</div>
        <div class="profile-info">
          <h2 id="profileName">Trader Name</h2>
          <p id="profileWallet">0x...</p>
          <div class="links">
            <a id="profilePolyLink" href="#" target="_blank" class="btn btn-ghost">Polymarket ‚Üó</a>
            <a id="profileScanLink" href="#" target="_blank" class="btn btn-ghost">Polygonscan ‚Üó</a>
          </div>
        </div>
      </div>
      <div class="profile-stats">
        <div class="profile-stat"><h4 id="profileValue" class="text-purple">$0</h4><p>Portfolio</p></div>
        <div class="profile-stat"><h4 id="profilePnl" class="text-green">$0</h4><p>Total PnL</p></div>
        <div class="profile-stat"><h4 id="profileWinRate">0%</h4><p>Win Rate</p></div>
        <div class="profile-stat"><h4 id="profilePositions">0</h4><p>Positions</p></div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="positions">üìä Positions</div>
        <div class="tab" data-tab="activity">üìú Activity</div>
      </div>
      <div id="positionsTab" class="tab-content active"></div>
      <div id="activityTab" class="tab-content"></div>
    </div>
  </div>

  <script>
    let markets = [], filtered = [], currentTag = 'all', currentEvent = null;

    const fmt = v => { 
      if (v >= 1e9) return '$' + (v/1e9).toFixed(2) + 'B';
      if (v >= 1e6) return '$' + (v/1e6).toFixed(2) + 'M';
      if (v >= 1e3) return '$' + (v/1e3).toFixed(1) + 'K';
      return '$' + v.toFixed(0);
    };
    const fmtPnl = v => (v >= 0 ? '+' : '') + fmt(v);
    const fmtShares = v => v >= 1e6 ? (v/1e6).toFixed(1) + 'M' : v >= 1e3 ? (v/1e3).toFixed(1) + 'K' : v.toFixed(0);

    const setStatus = ok => {
      const el = document.getElementById('status');
      el.className = 'status' + (ok ? '' : ' error');
      el.querySelector('span').textContent = ok ? 'Live' : 'Error';
    };

    const updateStats = () => {
      document.getElementById('statCount').textContent = filtered.length;
      document.getElementById('statVolume').textContent = fmt(filtered.reduce((s,m) => s + m.volume, 0));
      document.getElementById('statLiquidity').textContent = fmt(filtered.reduce((s,m) => s + m.liquidity, 0));
      const names = {'all':'All','sports':'Sports','politics':'Politics','crypto':'Crypto','pop-culture':'Culture','business':'Business','nfl':'NFL','nba':'NBA','soccer':'Soccer','mma':'MMA'};
      document.getElementById('statCategory').textContent = names[currentTag] || currentTag;
    };

    const render = () => {
      const grid = document.getElementById('grid');
      if (!filtered.length) { grid.innerHTML = '<div class="loading">No markets found</div>'; updateStats(); return; }
      
      grid.innerHTML = filtered.map((m, i) => {
        const rank = i + 1;
        const rc = rank === 1 ? 'r1' : rank === 2 ? 'r2' : rank === 3 ? 'r3' : '';
        const outcomes = m.outcomes || [];
        
        return `
          <div class="card" onclick="openEvent('${m.slug}')">
            <div class="card-rank ${rc}">${rank}</div>
            <div class="card-header">
              <img src="${m.image || ''}" class="card-img" onerror="this.style.display='none'">
              <div class="card-info">
                <h3>${m.title}</h3>
                <div class="card-meta">
                  <span class="tag">${m.category}</span>
                  ${m.outcomesCount > 1 ? `<span class="tag">${m.outcomesCount} outcomes</span>` : ''}
                </div>
              </div>
            </div>
            <div class="card-body">
              <div class="outcomes-preview">
                ${outcomes.slice(0,3).map(o => `
                  <div class="outcome-row">
                    <span class="outcome-name">${o.question}</span>
                    <span class="outcome-pct text-green">${o.price}%</span>
                    <div class="outcome-bar"><div class="outcome-bar-fill" style="width:${o.price}%"></div></div>
                  </div>
                `).join('')}
                ${outcomes.length > 3 ? `<div class="outcome-row"><span class="outcome-name" style="color:#666">+${outcomes.length - 3} more...</span></div>` : ''}
              </div>
              <div class="card-stats">
                <span>üìä ${fmt(m.volume)}</span>
                <span>üíß ${fmt(m.liquidity)}</span>
                ${m.endDate ? `<span>üìÖ ${new Date(m.endDate).toLocaleDateString()}</span>` : ''}
              </div>
            </div>
          </div>
        `;
      }).join('');
      updateStats();
    };

    const applyFilters = () => {
      const search = document.getElementById('search').value.toLowerCase();
      const sort = document.getElementById('sort').value;
      filtered = markets.filter(m => !search || m.title.toLowerCase().includes(search));
      filtered.sort((a,b) => sort === 'liquidity' ? b.liquidity - a.liquidity : sort === 'outcomes' ? b.outcomesCount - a.outcomesCount : b.volume - a.volume);
      render();
    };

    const fetchMarkets = async (tag = 'all') => {
      currentTag = tag;
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.tag === tag));
      document.getElementById('grid').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';
      
      try {
        const res = await fetch(`/api/markets?tag=${tag}&limit=200`);
        const json = await res.json();
        if (json.success && json.data?.length) { markets = json.data; setStatus(true); }
        else throw new Error(json.error || 'No data');
      } catch (e) {
        document.getElementById('grid').innerHTML = `<div class="loading">‚ùå ${e.message}<br><button class="btn btn-primary" onclick="fetchMarkets('${tag}')" style="margin-top:12px">Retry</button></div>`;
        setStatus(false);
        return;
      }
      applyFilters();
    };

    // Event Modal
    const openEvent = async (slug) => {
      document.getElementById('eventModal').classList.add('active');
      document.getElementById('outcomesList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('holdersList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const res = await fetch(`/api/event?slug=${encodeURIComponent(slug)}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);
        
        currentEvent = json.data;
        document.getElementById('eventTitle').textContent = currentEvent.title;
        document.getElementById('eventCategory').textContent = `${currentEvent.category} ¬∑ ${currentEvent.endDate ? new Date(currentEvent.endDate).toLocaleDateString() : 'No end date'}`;
        document.getElementById('eventVolume').textContent = fmt(currentEvent.volume);
        document.getElementById('eventLiquidity').textContent = fmt(currentEvent.liquidity);
        document.getElementById('eventOutcomes').textContent = currentEvent.outcomesCount;
        document.getElementById('eventEnd').textContent = currentEvent.endDate ? new Date(currentEvent.endDate).toLocaleDateString() : '-';
        document.getElementById('eventLink').href = `https://polymarket.com/event/${slug}`;
        
        // Render outcomes
        if (currentEvent.outcomes?.length) {
          document.getElementById('outcomesList').innerHTML = currentEvent.outcomes.map((o, i) => `
            <div class="outcome-card">
              <div class="outcome-rank ${i === 0 ? 'top' : ''}">${i + 1}</div>
              <div class="outcome-details">
                <h4>${o.question}</h4>
                <p>Vol: ${fmt(o.volume)}</p>
              </div>
              <div class="outcome-price">
                <h4 class="text-green">${o.yesPrice}%</h4>
                <div style="display:flex;gap:4px;margin-top:4px">
                  <span class="btn btn-yes" style="padding:4px 8px;font-size:10px;border-radius:4px">Yes ${o.yesPrice}¬¢</span>
                  <span class="btn btn-no" style="padding:4px 8px;font-size:10px;border-radius:4px">No ${o.noPrice}¬¢</span>
                </div>
              </div>
            </div>
          `).join('');
        } else {
          document.getElementById('outcomesList').innerHTML = '<p style="color:#666;text-align:center">No outcomes data</p>';
        }
        
        // Fetch holders for first outcome
        if (currentEvent.outcomes?.[0]?.conditionId) {
          fetchHolders(currentEvent.outcomes[0].conditionId);
        } else {
          document.getElementById('holdersList').innerHTML = '<p style="color:#666;text-align:center">No holders data</p>';
        }
        
      } catch (e) {
        document.getElementById('outcomesList').innerHTML = `<p style="color:#ff4757">Error: ${e.message}</p>`;
      }
    };

    const fetchHolders = async (conditionId) => {
      try {
        const res = await fetch(`/api/holders?market=${conditionId}&limit=20`);
        const json = await res.json();
        
        if (json.success && json.data?.length) {
          document.getElementById('holdersList').innerHTML = json.data.map(h => {
            const rc = h.rank === 1 ? 'g' : h.rank === 2 ? 's' : h.rank === 3 ? 'b' : '';
            return `
              <div class="holder-row" onclick="openProfile('${h.wallet}', '${h.displayName}')">
                <div class="holder-rank ${rc}">${h.rank}</div>
                <div class="holder-info">
                  <h4>${h.displayName || 'Anonymous'}</h4>
                  <p>${h.wallet.slice(0,6)}...${h.wallet.slice(-4)}</p>
                </div>
                <div class="holder-pos">
                  <h4>${fmtShares(h.amount)} shares</h4>
                  <span class="badge ${h.outcome === 'YES' ? 'badge-yes' : 'badge-no'}">${h.outcome}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          document.getElementById('holdersList').innerHTML = '<p style="color:#666;text-align:center">No holders found</p>';
        }
      } catch (e) {
        document.getElementById('holdersList').innerHTML = `<p style="color:#666;text-align:center">${e.message}</p>`;
      }
    };

    const closeEventModal = () => {
      document.getElementById('eventModal').classList.remove('active');
      currentEvent = null;
    };

    // Profile Modal
    const openProfile = async (wallet, name) => {
      document.getElementById('profileModal').classList.add('active');
      document.getElementById('profileName').textContent = name || 'Trader';
      document.getElementById('profileWallet').textContent = wallet;
      document.getElementById('profileAvatar').textContent = (name || wallet).charAt(0).toUpperCase();
      document.getElementById('profilePolyLink').href = `https://polymarket.com/profile/${wallet}`;
      document.getElementById('profileScanLink').href = `https://polygonscan.com/address/${wallet}`;
      document.getElementById('positionsTab').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('activityTab').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      
      try {
        const res = await fetch(`/api/profile?wallet=${wallet}`);
        const json = await res.json();
        
        if (json.success) {
          const d = json.data;
          document.getElementById('profileValue').textContent = fmt(d.portfolioValue);
          document.getElementById('profilePnl').textContent = fmtPnl(d.totalPnl);
          document.getElementById('profilePnl').className = d.totalPnl >= 0 ? 'text-green' : 'text-red';
          document.getElementById('profileWinRate').textContent = d.winRate + '%';
          document.getElementById('profilePositions').textContent = d.positionsCount;
          
          // Positions
          if (d.positions?.length) {
            document.getElementById('positionsTab').innerHTML = d.positions.map(p => `
              <div class="position-card">
                <img src="${p.image || ''}" class="position-img" onerror="this.style.background='#1a1a1a'">
                <div class="position-info">
                  <h4>${p.market}</h4>
                  <p>${p.outcome} ¬∑ Avg: ${Math.round(p.avgPrice * 100)}¬¢ ‚Üí Now: ${Math.round(p.currentPrice * 100)}¬¢</p>
                </div>
                <div class="position-values">
                  <h4>${fmt(p.currentValue)}</h4>
                  <p class="${p.pnl >= 0 ? 'text-green' : 'text-red'}">${fmtPnl(p.pnl)} (${p.pnlPercent.toFixed(1)}%)</p>
                </div>
              </div>
            `).join('');
          } else {
            document.getElementById('positionsTab').innerHTML = '<p style="color:#666;text-align:center;padding:20px">No positions</p>';
          }
          
          // Activity
          if (d.recentActivity?.length) {
            document.getElementById('activityTab').innerHTML = d.recentActivity.map(a => `
              <div class="activity-row">
                <span class="activity-type ${a.side?.toLowerCase()}">${a.type}</span>
                <div class="activity-info">
                  <h4>${a.market}</h4>
                  <p>${a.side} ${a.outcome} @ ${Math.round(a.price * 100)}¬¢</p>
                </div>
                <div class="activity-amount">${fmt(a.usdcSize || a.size)}</div>
              </div>
            `).join('');
          } else {
            document.getElementById('activityTab').innerHTML = '<p style="color:#666;text-align:center;padding:20px">No activity</p>';
          }
        }
      } catch (e) {
        document.getElementById('positionsTab').innerHTML = `<p style="color:#ff4757;padding:20px">${e.message}</p>`;
      }
    };

    const closeProfileModal = () => document.getElementById('profileModal').classList.remove('active');

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });

    // Events
    document.querySelectorAll('.cat-btn').forEach(b => b.addEventListener('click', () => fetchMarkets(b.dataset.tag)));
    document.getElementById('search').addEventListener('input', applyFilters);
    document.getElementById('sort').addEventListener('change', applyFilters);
    document.getElementById('refresh').addEventListener('click', () => fetchMarkets(currentTag));
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeEventModal(); closeProfileModal(); } });

    // Init
    fetchMarkets('all');
  </script>
</body>
</html>
