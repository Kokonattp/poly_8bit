<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PolyMarket Pro</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, sans-serif; background: #f8f9fc; color: #1a1a2e; min-height: 100vh; }
    
    /* Header */
    .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 16px 24px; position: sticky; top: 0; z-index: 100; }
    .header-inner { max-width: 1400px; margin: 0 auto; display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 12px; color: #fff; }
    .logo-icon { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 18px; }
    .logo h1 { font-size: 20px; font-weight: 700; }
    .logo span { font-size: 12px; opacity: 0.8; display: block; }
    .header-right { display: flex; gap: 12px; align-items: center; }
    .btn { padding: 10px 20px; border-radius: 10px; font-weight: 600; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
    .btn-white { background: #fff; color: #667eea; }
    .btn-white:hover { background: #f0f0f0; }
    .status { background: rgba(255,255,255,0.2); color: #fff; padding: 8px 14px; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #4ade80; animation: pulse 2s infinite; }
    @keyframes pulse { 0%,100% { opacity: 1; } 50% { opacity: 0.5; } }

    /* Main */
    .main { max-width: 1400px; margin: 0 auto; padding: 24px; }

    /* Stats Row */
    .stats-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    @media (max-width: 900px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 500px) { .stats-grid { grid-template-columns: 1fr; } }
    .stat-card { background: #fff; border-radius: 16px; padding: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); }
    .stat-card .icon { width: 44px; height: 44px; border-radius: 12px; display: flex; align-items: center; justify-content: center; font-size: 20px; margin-bottom: 12px; }
    .stat-card .icon.purple { background: rgba(102,126,234,0.1); }
    .stat-card .icon.green { background: rgba(74,222,128,0.1); }
    .stat-card .icon.blue { background: rgba(59,130,246,0.1); }
    .stat-card .icon.orange { background: rgba(251,146,60,0.1); }
    .stat-card p { color: #6b7280; font-size: 13px; margin-bottom: 4px; }
    .stat-card h3 { font-size: 26px; font-weight: 700; }
    .text-purple { color: #667eea; }
    .text-green { color: #22c55e; }
    .text-blue { color: #3b82f6; }
    .text-red { color: #ef4444; }

    /* Categories */
    .categories { display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; }
    .cat-btn { padding: 10px 20px; border-radius: 25px; font-size: 14px; font-weight: 500; background: #fff; border: 2px solid #e5e7eb; color: #6b7280; cursor: pointer; transition: all 0.2s; }
    .cat-btn:hover { border-color: #667eea; color: #667eea; }
    .cat-btn.active { background: #667eea; border-color: #667eea; color: #fff; }

    /* Search & Filter */
    .toolbar { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; align-items: center; }
    .search-box { flex: 1; min-width: 250px; }
    .search-box input { width: 100%; padding: 14px 16px 14px 48px; background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; outline: none; transition: border 0.2s; }
    .search-box input:focus { border-color: #667eea; }
    .search-box { position: relative; }
    .search-box::before { content: 'üîç'; position: absolute; left: 18px; top: 50%; transform: translateY(-50%); font-size: 16px; }
    select { padding: 14px 16px; background: #fff; border: 2px solid #e5e7eb; border-radius: 12px; font-size: 14px; cursor: pointer; outline: none; }
    select:focus { border-color: #667eea; }
    .btn-primary { background: #667eea; color: #fff; padding: 14px 24px; }
    .btn-primary:hover { background: #5a67d8; }

    /* Markets Grid */
    .markets-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 16px; }
    @media (max-width: 500px) { .markets-grid { grid-template-columns: 1fr; } }

    .market-card { background: #fff; border-radius: 16px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: all 0.2s; cursor: pointer; }
    .market-card:hover { box-shadow: 0 8px 24px rgba(0,0,0,0.08); transform: translateY(-2px); }
    .market-header { display: flex; gap: 14px; padding: 18px; }
    .market-rank { width: 32px; height: 32px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 13px; font-weight: 700; background: #f3f4f6; color: #6b7280; flex-shrink: 0; }
    .market-rank.r1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #fff; }
    .market-rank.r2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #fff; }
    .market-rank.r3 { background: linear-gradient(135deg, #f97316, #ea580c); color: #fff; }
    .market-img { width: 52px; height: 52px; border-radius: 12px; object-fit: cover; background: #f3f4f6; flex-shrink: 0; }
    .market-info { flex: 1; min-width: 0; }
    .market-info h3 { font-size: 15px; font-weight: 600; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
    .market-tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
    .tag { font-size: 11px; padding: 4px 10px; background: #f3f4f6; border-radius: 6px; color: #6b7280; font-weight: 500; }

    .market-outcomes { padding: 0 18px 18px; }
    .outcome-row { display: flex; align-items: center; gap: 12px; padding: 10px 0; border-bottom: 1px solid #f3f4f6; }
    .outcome-row:last-child { border-bottom: none; }
    .outcome-name { flex: 1; font-size: 13px; color: #4b5563; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .outcome-price { font-size: 15px; font-weight: 700; min-width: 50px; text-align: right; }
    .outcome-bar { width: 80px; height: 6px; background: #e5e7eb; border-radius: 3px; overflow: hidden; }
    .outcome-bar-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); border-radius: 3px; }

    .market-footer { display: flex; justify-content: space-between; padding: 14px 18px; background: #f9fafb; font-size: 12px; color: #6b7280; }
    .market-footer span { display: flex; align-items: center; gap: 4px; }

    /* Pagination */
    .pagination { display: flex; justify-content: center; align-items: center; gap: 12px; margin-top: 32px; padding: 20px; }
    .pagination button { padding: 12px 24px; border-radius: 10px; border: 2px solid #e5e7eb; background: #fff; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .pagination button:hover:not(:disabled) { border-color: #667eea; color: #667eea; }
    .pagination button:disabled { opacity: 0.5; cursor: not-allowed; }
    .pagination span { color: #6b7280; font-size: 14px; }

    /* Loading */
    .loading { text-align: center; padding: 60px; color: #6b7280; grid-column: 1/-1; }
    .spinner { width: 40px; height: 40px; border: 3px solid #e5e7eb; border-top-color: #667eea; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); z-index: 200; display: none; padding: 24px; overflow-y: auto; }
    .modal-overlay.active { display: flex; justify-content: center; align-items: flex-start; }
    .modal { background: #fff; border-radius: 20px; width: 100%; max-width: 700px; overflow: hidden; margin: auto; }
    .modal-header { padding: 24px; border-bottom: 1px solid #e5e7eb; }
    .modal-header-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 16px; }
    .modal-header h2 { font-size: 20px; font-weight: 700; line-height: 1.4; }
    .modal-header p { color: #6b7280; font-size: 14px; margin-top: 8px; }
    .close-btn { width: 36px; height: 36px; border-radius: 10px; background: #f3f4f6; border: none; cursor: pointer; font-size: 18px; color: #6b7280; flex-shrink: 0; }
    .close-btn:hover { background: #e5e7eb; color: #1a1a2e; }

    /* Event Stats */
    .event-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 1px; background: #e5e7eb; }
    @media (max-width: 500px) { .event-stats { grid-template-columns: repeat(2, 1fr); } }
    .event-stat { background: #fff; padding: 20px; text-align: center; }
    .event-stat h4 { font-size: 22px; font-weight: 700; color: #667eea; }
    .event-stat p { font-size: 12px; color: #6b7280; margin-top: 4px; }

    /* Outcomes List */
    .section { padding: 20px 24px; }
    .section-title { font-size: 15px; font-weight: 600; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    .outcomes-list { display: flex; flex-direction: column; gap: 8px; max-height: 320px; overflow-y: auto; }
    .outcome-card { display: flex; align-items: center; gap: 14px; padding: 14px 16px; background: #f9fafb; border-radius: 12px; cursor: pointer; transition: all 0.15s; border: 2px solid transparent; }
    .outcome-card:hover { background: #f3f4f6; }
    .outcome-card.selected { border-color: #667eea; background: rgba(102,126,234,0.05); }
    .outcome-num { width: 28px; height: 28px; border-radius: 8px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; color: #6b7280; }
    .outcome-num.top { background: #667eea; color: #fff; }
    .outcome-details { flex: 1; min-width: 0; }
    .outcome-details h4 { font-size: 14px; font-weight: 500; }
    .outcome-details p { font-size: 12px; color: #6b7280; margin-top: 2px; }
    .outcome-price-box { text-align: right; }
    .outcome-price-box h4 { font-size: 18px; font-weight: 700; }
    .outcome-btns { display: flex; gap: 6px; margin-top: 6px; }
    .btn-yes { background: rgba(34,197,94,0.1); color: #22c55e; padding: 4px 10px; font-size: 11px; border-radius: 6px; font-weight: 600; }
    .btn-no { background: rgba(239,68,68,0.1); color: #ef4444; padding: 4px 10px; font-size: 11px; border-radius: 6px; font-weight: 600; }

    /* Holders List */
    .holders-list { display: flex; flex-direction: column; gap: 6px; max-height: 280px; overflow-y: auto; }
    .holder-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: #f9fafb; border-radius: 10px; cursor: pointer; transition: all 0.15s; }
    .holder-row:hover { background: #f3f4f6; }
    .holder-rank { width: 26px; height: 26px; border-radius: 8px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; font-size: 11px; font-weight: 700; color: #6b7280; }
    .holder-rank.g { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #fff; }
    .holder-rank.s { background: linear-gradient(135deg, #94a3b8, #64748b); color: #fff; }
    .holder-rank.b { background: linear-gradient(135deg, #f97316, #ea580c); color: #fff; }
    .holder-info { flex: 1; min-width: 0; }
    .holder-info h4 { font-size: 13px; font-weight: 500; }
    .holder-info p { font-size: 11px; color: #9ca3af; font-family: monospace; }
    .holder-pos { text-align: right; }
    .holder-pos h4 { font-size: 13px; font-weight: 600; }
    .holder-pos .badge { font-size: 10px; padding: 3px 8px; border-radius: 4px; font-weight: 600; }
    .badge-yes { background: rgba(34,197,94,0.1); color: #22c55e; }
    .badge-no { background: rgba(239,68,68,0.1); color: #ef4444; }

    /* Holders Stats */
    .holders-stats { display: flex; gap: 16px; margin-bottom: 16px; flex-wrap: wrap; }
    .holders-stat { background: #f9fafb; padding: 12px 16px; border-radius: 10px; flex: 1; min-width: 100px; }
    .holders-stat p { font-size: 11px; color: #6b7280; }
    .holders-stat h4 { font-size: 16px; font-weight: 600; margin-top: 2px; }

    /* Profile Modal */
    .profile-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 32px 24px; color: #fff; }
    .profile-avatar { width: 64px; height: 64px; border-radius: 16px; background: rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 700; margin-bottom: 16px; }
    .profile-header h2 { font-size: 22px; font-weight: 700; }
    .profile-header p { font-size: 13px; opacity: 0.8; font-family: monospace; margin-top: 6px; }
    .profile-links { margin-top: 12px; display: flex; gap: 8px; }
    .profile-links a { background: rgba(255,255,255,0.2); color: #fff; padding: 8px 16px; border-radius: 8px; font-size: 12px; text-decoration: none; font-weight: 500; }
    .profile-links a:hover { background: rgba(255,255,255,0.3); }

    .profile-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; padding: 20px 24px; background: #f9fafb; }
    @media (max-width: 600px) { .profile-stats { grid-template-columns: repeat(2, 1fr); } }
    .profile-stat { background: #fff; padding: 16px; border-radius: 12px; text-align: center; }
    .profile-stat h4 { font-size: 20px; font-weight: 700; }
    .profile-stat p { font-size: 11px; color: #6b7280; margin-top: 4px; }

    /* Tabs */
    .tabs { display: flex; border-bottom: 2px solid #e5e7eb; padding: 0 24px; }
    .tab { padding: 16px 20px; font-size: 14px; font-weight: 600; color: #6b7280; cursor: pointer; border-bottom: 2px solid transparent; margin-bottom: -2px; transition: all 0.2s; }
    .tab:hover { color: #667eea; }
    .tab.active { color: #667eea; border-color: #667eea; }
    .tab-content { display: none; padding: 20px 24px; max-height: 350px; overflow-y: auto; }
    .tab-content.active { display: block; }

    .position-card { display: flex; align-items: center; gap: 14px; padding: 14px; background: #f9fafb; border-radius: 12px; margin-bottom: 10px; }
    .position-img { width: 44px; height: 44px; border-radius: 10px; background: #e5e7eb; object-fit: cover; }
    .position-info { flex: 1; min-width: 0; }
    .position-info h4 { font-size: 13px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .position-info p { font-size: 11px; color: #6b7280; margin-top: 2px; }
    .position-values { text-align: right; }
    .position-values h4 { font-size: 14px; font-weight: 600; }
    .position-values p { font-size: 12px; margin-top: 2px; }

    .activity-row { display: flex; align-items: center; gap: 12px; padding: 12px 14px; background: #f9fafb; border-radius: 10px; margin-bottom: 8px; }
    .activity-type { padding: 5px 10px; border-radius: 6px; font-size: 11px; font-weight: 600; }
    .activity-type.buy { background: rgba(34,197,94,0.1); color: #22c55e; }
    .activity-type.sell { background: rgba(239,68,68,0.1); color: #ef4444; }
    .activity-info { flex: 1; min-width: 0; }
    .activity-info h4 { font-size: 12px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .activity-info p { font-size: 11px; color: #6b7280; }
    .activity-amount { font-weight: 600; font-size: 13px; }

    /* Footer */
    .footer { text-align: center; padding: 32px 24px; color: #9ca3af; font-size: 13px; }
    .footer a { color: #667eea; text-decoration: none; }
  </style>
</head>
<body>
  <header class="header">
    <div class="header-inner">
      <div class="logo">
        <div class="logo-icon">P</div>
        <div>
          <h1>PolyMarket Pro</h1>
          <span>Top 1000 Prediction Markets</span>
        </div>
      </div>
      <div class="header-right">
        <a href="https://polymarket.com" target="_blank" class="btn btn-white">Open Polymarket ‚Üó</a>
        <div class="status"><div class="status-dot"></div><span id="statusText">Live</span></div>
      </div>
    </div>
  </header>

  <main class="main">
    <div class="stats-grid">
      <div class="stat-card">
        <div class="icon purple">üìä</div>
        <p>Total Markets</p>
        <h3 id="statCount">-</h3>
      </div>
      <div class="stat-card">
        <div class="icon green">üí∞</div>
        <p>Total Volume</p>
        <h3 id="statVolume" class="text-purple">-</h3>
      </div>
      <div class="stat-card">
        <div class="icon blue">üíß</div>
        <p>Total Liquidity</p>
        <h3 id="statLiquidity" class="text-green">-</h3>
      </div>
      <div class="stat-card">
        <div class="icon orange">üìÅ</div>
        <p>Category</p>
        <h3 id="statCategory">All</h3>
      </div>
    </div>

    <div class="categories">
      <button class="cat-btn active" data-tag="all">üåê All</button>
      <button class="cat-btn" data-tag="sports">‚öΩ Sports</button>
      <button class="cat-btn" data-tag="politics">üèõÔ∏è Politics</button>
      <button class="cat-btn" data-tag="crypto">‚Çø Crypto</button>
      <button class="cat-btn" data-tag="entertainment">üé¨ Entertainment</button>
      <button class="cat-btn" data-tag="business">üíº Business</button>
      <button class="cat-btn" data-tag="science">üî¨ Science</button>
    </div>

    <div class="toolbar">
      <div class="search-box">
        <input type="text" id="search" placeholder="Search markets...">
      </div>
      <select id="sort">
        <option value="volume">Sort by Volume</option>
        <option value="liquidity">Sort by Liquidity</option>
        <option value="outcomes">Sort by Outcomes</option>
      </select>
      <button id="refresh" class="btn btn-primary">‚Üª Refresh</button>
    </div>

    <div id="grid" class="markets-grid">
      <div class="loading"><div class="spinner"></div><p>Loading markets...</p></div>
    </div>

    <div class="pagination" id="pagination" style="display:none">
      <button id="prevBtn">‚Üê Previous</button>
      <span id="pageInfo">Page 1 of 10</span>
      <button id="nextBtn">Next ‚Üí</button>
    </div>

    <div class="footer">
      Data from <a href="https://polymarket.com" target="_blank">Polymarket</a> ¬∑ Trading involves risk ¬∑ Not financial advice
    </div>
  </main>

  <!-- Event Modal -->
  <div id="eventModal" class="modal-overlay">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div class="modal-header-top">
          <div>
            <h2 id="eventTitle">Event Title</h2>
            <p id="eventMeta">Category ¬∑ End Date</p>
          </div>
          <button class="close-btn" onclick="closeEvent()">‚úï</button>
        </div>
        <div style="margin-top:12px">
          <a id="eventLink" href="#" target="_blank" class="btn btn-primary" style="font-size:13px;padding:10px 16px">Open in Polymarket ‚Üó</a>
        </div>
      </div>
      <div class="event-stats">
        <div class="event-stat"><h4 id="eventVolume">$0</h4><p>Volume</p></div>
        <div class="event-stat"><h4 id="eventLiquidity">$0</h4><p>Liquidity</p></div>
        <div class="event-stat"><h4 id="eventOutcomes">0</h4><p>Outcomes</p></div>
        <div class="event-stat"><h4 id="eventComments">0</h4><p>Comments</p></div>
      </div>
      <div class="section">
        <div class="section-title">üèÜ All Outcomes (sorted by % chance)</div>
        <div id="outcomesList" class="outcomes-list"></div>
      </div>
      <div class="section" style="border-top: 1px solid #e5e7eb">
        <div class="section-title">üë• Top Traders</div>
        <div id="holdersStats" class="holders-stats"></div>
        <div id="holdersList" class="holders-list"></div>
      </div>
    </div>
  </div>

  <!-- Profile Modal -->
  <div id="profileModal" class="modal-overlay">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="profile-header">
        <div style="display:flex;justify-content:space-between;align-items:flex-start">
          <div>
            <div class="profile-avatar" id="profileAvatar">?</div>
            <h2 id="profileName">Trader</h2>
            <p id="profileWallet">0x...</p>
          </div>
          <button class="close-btn" style="background:rgba(255,255,255,0.2);color:#fff" onclick="closeProfile()">‚úï</button>
        </div>
        <div class="profile-links">
          <a id="profilePolyLink" href="#" target="_blank">Polymarket ‚Üó</a>
          <a id="profileScanLink" href="#" target="_blank">Polygonscan ‚Üó</a>
        </div>
      </div>
      <div class="profile-stats">
        <div class="profile-stat"><h4 id="profileValue" class="text-purple">$0</h4><p>Positions</p></div>
        <div class="profile-stat"><h4 id="profilePnl" class="text-green">$0</h4><p>PNL</p></div>
        <div class="profile-stat"><h4 id="profileVolume">$0</h4><p>Total Vol</p></div>
        <div class="profile-stat"><h4 id="profileMarkets">0</h4><p>Markets</p></div>
      </div>
      <div class="tabs">
        <div class="tab active" data-tab="positions">üìä Positions</div>
        <div class="tab" data-tab="activity">üìú Activity</div>
      </div>
      <div id="positionsTab" class="tab-content active"></div>
      <div id="activityTab" class="tab-content"></div>
    </div>
  </div>

  <script>
    let markets = [], filtered = [], currentTag = 'all', currentPage = 1, totalPages = 1;
    let currentEvent = null, currentOutcome = null;

    const fmt = v => {
      if (v >= 1e9) return '$' + (v/1e9).toFixed(2) + 'B';
      if (v >= 1e6) return '$' + (v/1e6).toFixed(2) + 'M';
      if (v >= 1e3) return '$' + (v/1e3).toFixed(1) + 'K';
      return '$' + v.toFixed(0);
    };
    const fmtPnl = v => (v >= 0 ? '+' : '') + fmt(v);
    const fmtShares = v => v >= 1e6 ? (v/1e6).toFixed(1)+'M' : v >= 1e3 ? (v/1e3).toFixed(1)+'K' : v.toFixed(0);

    const setStatus = ok => {
      document.getElementById('statusText').textContent = ok ? 'Live' : 'Error';
    };

    const updateStats = (data) => {
      document.getElementById('statCount').textContent = data.pagination?.total || filtered.length;
      document.getElementById('statVolume').textContent = fmt(filtered.reduce((s,m) => s + m.volume, 0));
      document.getElementById('statLiquidity').textContent = fmt(filtered.reduce((s,m) => s + m.liquidity, 0));
      const names = {'all':'All','sports':'Sports','politics':'Politics','crypto':'Crypto','entertainment':'Entertainment','business':'Business','science':'Science'};
      document.getElementById('statCategory').textContent = names[currentTag] || currentTag;
    };

    const renderMarkets = () => {
      const grid = document.getElementById('grid');
      if (!filtered.length) {
        grid.innerHTML = '<div class="loading">No markets found</div>';
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      grid.innerHTML = filtered.map((m, i) => {
        const rank = ((currentPage - 1) * 100) + i + 1;
        const rc = rank === 1 ? 'r1' : rank === 2 ? 'r2' : rank === 3 ? 'r3' : '';
        const outcomes = m.outcomes || [];

        return `
          <div class="market-card" onclick="openEvent('${m.slug}')">
            <div class="market-header">
              <div class="market-rank ${rc}">${rank}</div>
              <img src="${m.image || ''}" class="market-img" onerror="this.style.background='#e5e7eb'">
              <div class="market-info">
                <h3>${m.title}</h3>
                <div class="market-tags">
                  ${m.tags.slice(0,2).map(t => `<span class="tag">${t}</span>`).join('')}
                  ${m.outcomesCount > 1 ? `<span class="tag">${m.outcomesCount} outcomes</span>` : ''}
                </div>
              </div>
            </div>
            <div class="market-outcomes">
              ${outcomes.slice(0,3).map(o => `
                <div class="outcome-row">
                  <span class="outcome-name">${o.name}</span>
                  <span class="outcome-price ${o.price >= 50 ? 'text-green' : 'text-blue'}">${o.price}%</span>
                  <div class="outcome-bar"><div class="outcome-bar-fill" style="width:${o.price}%"></div></div>
                </div>
              `).join('')}
              ${outcomes.length > 3 ? `<div class="outcome-row"><span class="outcome-name" style="color:#9ca3af">+${outcomes.length - 3} more</span></div>` : ''}
            </div>
            <div class="market-footer">
              <span>üìä ${fmt(m.volume)}</span>
              <span>üíß ${fmt(m.liquidity)}</span>
              ${m.commentCount ? `<span>üí¨ ${m.commentCount}</span>` : ''}
              ${m.endDate ? `<span>üìÖ ${new Date(m.endDate).toLocaleDateString()}</span>` : ''}
            </div>
          </div>
        `;
      }).join('');

      // Pagination
      const pag = document.getElementById('pagination');
      if (totalPages > 1) {
        pag.style.display = 'flex';
        document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
        document.getElementById('prevBtn').disabled = currentPage <= 1;
        document.getElementById('nextBtn').disabled = currentPage >= totalPages;
      } else {
        pag.style.display = 'none';
      }
    };

    const fetchMarkets = async (tag = 'all', page = 1) => {
      currentTag = tag;
      currentPage = page;
      document.querySelectorAll('.cat-btn').forEach(b => b.classList.toggle('active', b.dataset.tag === tag));
      document.getElementById('grid').innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading...</p></div>';

      try {
        const res = await fetch(`/api/markets?tag=${tag}&page=${page}&limit=100`);
        const json = await res.json();
        if (json.success) {
          markets = json.data;
          filtered = markets;
          totalPages = json.pagination?.totalPages || 1;
          setStatus(true);
          updateStats(json);
          applyFilters();
        } else throw new Error(json.error);
      } catch (e) {
        document.getElementById('grid').innerHTML = `<div class="loading">‚ùå ${e.message}</div>`;
        setStatus(false);
      }
    };

    const applyFilters = () => {
      const search = document.getElementById('search').value.toLowerCase();
      const sort = document.getElementById('sort').value;
      filtered = markets.filter(m => !search || m.title.toLowerCase().includes(search));
      filtered.sort((a,b) => sort === 'liquidity' ? b.liquidity - a.liquidity : sort === 'outcomes' ? b.outcomesCount - a.outcomesCount : b.volume - a.volume);
      renderMarkets();
    };

    // Event Modal
    const openEvent = async (slug) => {
      document.getElementById('eventModal').classList.add('active');
      document.getElementById('outcomesList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('holdersList').innerHTML = '';
      document.getElementById('holdersStats').innerHTML = '';

      try {
        const res = await fetch(`/api/event?slug=${encodeURIComponent(slug)}`);
        const json = await res.json();
        if (!json.success) throw new Error(json.error);

        currentEvent = json.data;
        document.getElementById('eventTitle').textContent = currentEvent.title;
        document.getElementById('eventMeta').textContent = `${currentEvent.category} ¬∑ ${currentEvent.endDate ? 'Ends ' + new Date(currentEvent.endDate).toLocaleDateString() : ''}`;
        document.getElementById('eventVolume').textContent = fmt(currentEvent.volume);
        document.getElementById('eventLiquidity').textContent = fmt(currentEvent.liquidity);
        document.getElementById('eventOutcomes').textContent = currentEvent.outcomes.length;
        document.getElementById('eventComments').textContent = currentEvent.commentCount;
        document.getElementById('eventLink').href = `https://polymarket.com/event/${slug}`;

        if (currentEvent.outcomes?.length) {
          document.getElementById('outcomesList').innerHTML = currentEvent.outcomes.map((o, i) => `
            <div class="outcome-card ${i === 0 ? 'selected' : ''}" onclick="selectOutcome('${o.conditionId}', this)">
              <div class="outcome-num ${i === 0 ? 'top' : ''}">${i + 1}</div>
              <div class="outcome-details">
                <h4>${o.name}</h4>
                <p>Vol: ${fmt(o.volume)} ¬∑ Liq: ${fmt(o.liquidity)}</p>
              </div>
              <div class="outcome-price-box">
                <h4 class="${o.yesPrice >= 50 ? 'text-green' : 'text-red'}">${o.yesPrice}%</h4>
                <div class="outcome-btns">
                  <span class="btn-yes">Yes ${o.yesPrice}¬¢</span>
                  <span class="btn-no">No ${o.noPrice}¬¢</span>
                </div>
              </div>
            </div>
          `).join('');

          // Load first outcome holders
          if (currentEvent.outcomes[0]?.conditionId) {
            loadHolders(currentEvent.outcomes[0].conditionId);
          }
        } else {
          document.getElementById('outcomesList').innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No outcomes</p>';
        }
      } catch (e) {
        document.getElementById('outcomesList').innerHTML = `<p style="color:#ef4444;padding:20px">${e.message}</p>`;
      }
    };

    const selectOutcome = (conditionId, el) => {
      document.querySelectorAll('.outcome-card').forEach(c => c.classList.remove('selected'));
      el.classList.add('selected');
      loadHolders(conditionId);
    };

    const loadHolders = async (conditionId) => {
      document.getElementById('holdersList').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('holdersStats').innerHTML = '';

      try {
        const res = await fetch(`/api/holders?market=${conditionId}&limit=30`);
        const json = await res.json();

        if (json.success && json.data?.length) {
          // Stats
          const s = json.stats;
          document.getElementById('holdersStats').innerHTML = `
            <div class="holders-stat"><p>Total Holders</p><h4>${s.totalHolders}</h4></div>
            <div class="holders-stat"><p>YES Holders</p><h4 class="text-green">${s.yesHolders} (${s.yesPct}%)</h4></div>
            <div class="holders-stat"><p>NO Holders</p><h4 class="text-red">${s.noHolders} (${100-s.yesPct}%)</h4></div>
          `;

          document.getElementById('holdersList').innerHTML = json.data.map(h => {
            const rc = h.rank === 1 ? 'g' : h.rank === 2 ? 's' : h.rank === 3 ? 'b' : '';
            return `
              <div class="holder-row" onclick="openProfile('${h.wallet}', '${h.displayName}')">
                <div class="holder-rank ${rc}">${h.rank}</div>
                <div class="holder-info">
                  <h4>${h.displayName}</h4>
                  <p>${h.wallet.slice(0,6)}...${h.wallet.slice(-4)}</p>
                </div>
                <div class="holder-pos">
                  <h4>${fmtShares(h.amount)} shares</h4>
                  <span class="badge ${h.outcome === 'YES' ? 'badge-yes' : 'badge-no'}">${h.outcome}</span>
                </div>
              </div>
            `;
          }).join('');
        } else {
          document.getElementById('holdersList').innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No holders data</p>';
        }
      } catch (e) {
        document.getElementById('holdersList').innerHTML = `<p style="color:#6b7280;padding:20px">${e.message}</p>`;
      }
    };

    const closeEvent = () => {
      document.getElementById('eventModal').classList.remove('active');
      currentEvent = null;
    };

    // Profile Modal
    const openProfile = async (wallet, name) => {
      document.getElementById('profileModal').classList.add('active');
      document.getElementById('profileName').textContent = name || 'Trader';
      document.getElementById('profileWallet').textContent = wallet;
      document.getElementById('profileAvatar').textContent = (name || wallet).charAt(0).toUpperCase();
      document.getElementById('profilePolyLink').href = `https://polymarket.com/profile/${wallet}`;
      document.getElementById('profileScanLink').href = `https://polygonscan.com/address/${wallet}`;
      document.getElementById('positionsTab').innerHTML = '<div class="loading"><div class="spinner"></div></div>';
      document.getElementById('activityTab').innerHTML = '';

      try {
        const res = await fetch(`/api/profile?wallet=${wallet}`);
        const json = await res.json();

        if (json.success) {
          const d = json.data;
          const s = d.stats;
          document.getElementById('profileValue').textContent = fmt(s.portfolioValue);
          document.getElementById('profilePnl').textContent = fmtPnl(s.totalPnl);
          document.getElementById('profilePnl').className = s.totalPnl >= 0 ? 'text-green' : 'text-red';
          document.getElementById('profileVolume').textContent = fmt(s.totalVolume);
          document.getElementById('profileMarkets').textContent = s.marketsCount;

          // Positions
          if (d.positions?.length) {
            document.getElementById('positionsTab').innerHTML = d.positions.map(p => `
              <div class="position-card">
                <img src="${p.image || ''}" class="position-img" onerror="this.style.background='#e5e7eb'">
                <div class="position-info">
                  <h4>${p.market}</h4>
                  <p>${p.outcome} ¬∑ Avg: ${Math.round(p.avgPrice * 100)}¬¢ ‚Üí ${Math.round(p.currentPrice * 100)}¬¢</p>
                </div>
                <div class="position-values">
                  <h4>${fmt(p.currentValue)}</h4>
                  <p class="${p.pnl >= 0 ? 'text-green' : 'text-red'}">${fmtPnl(p.pnl)}</p>
                </div>
              </div>
            `).join('');
          } else {
            document.getElementById('positionsTab').innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No positions</p>';
          }

          // Activity
          if (d.recentActivity?.length) {
            document.getElementById('activityTab').innerHTML = d.recentActivity.map(a => `
              <div class="activity-row">
                <span class="activity-type ${a.side?.toLowerCase()}">${a.side || a.type}</span>
                <div class="activity-info">
                  <h4>${a.market}</h4>
                  <p>${a.outcome} @ ${Math.round(a.price * 100)}¬¢</p>
                </div>
                <div class="activity-amount">${fmt(a.usdcSize || a.size)}</div>
              </div>
            `).join('');
          } else {
            document.getElementById('activityTab').innerHTML = '<p style="color:#6b7280;text-align:center;padding:20px">No activity</p>';
          }
        }
      } catch (e) {
        document.getElementById('positionsTab').innerHTML = `<p style="color:#ef4444;padding:20px">${e.message}</p>`;
      }
    };

    const closeProfile = () => document.getElementById('profileModal').classList.remove('active');

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        tab.classList.add('active');
        document.getElementById(tab.dataset.tab + 'Tab').classList.add('active');
      });
    });

    // Modal close on overlay click
    document.getElementById('eventModal').addEventListener('click', closeEvent);
    document.getElementById('profileModal').addEventListener('click', closeProfile);

    // Events
    document.querySelectorAll('.cat-btn').forEach(b => b.addEventListener('click', () => fetchMarkets(b.dataset.tag, 1)));
    document.getElementById('search').addEventListener('input', applyFilters);
    document.getElementById('sort').addEventListener('change', applyFilters);
    document.getElementById('refresh').addEventListener('click', () => fetchMarkets(currentTag, currentPage));
    document.getElementById('prevBtn').addEventListener('click', () => { if (currentPage > 1) fetchMarkets(currentTag, currentPage - 1); });
    document.getElementById('nextBtn').addEventListener('click', () => { if (currentPage < totalPages) fetchMarkets(currentTag, currentPage + 1); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') { closeEvent(); closeProfile(); } });

    // Init
    fetchMarkets('all', 1);
  </script>
</body>
</html>
