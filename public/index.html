<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Polymarket Leaderboard - Top 200 Traders</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Prompt:wght@400;500;600&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', 'Prompt', sans-serif; }
    body { background: #0d0d0d; color: #fff; min-height: 100vh; }
    
    /* Scrollbar */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: #141414; }
    ::-webkit-scrollbar-thumb { background: #2a2a2a; border-radius: 3px; }
    
    /* Header */
    .header { border-bottom: 1px solid #2a2a2a; padding: 16px 24px; display: flex; align-items: center; justify-content: space-between; position: sticky; top: 0; background: #0d0d0d; z-index: 40; }
    .logo { display: flex; align-items: center; gap: 12px; }
    .logo-icon { width: 40px; height: 40px; border-radius: 10px; background: linear-gradient(135deg, #3b82f6, #8b5cf6); display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 18px; }
    .logo-text h1 { font-size: 18px; font-weight: 600; }
    .logo-text p { font-size: 12px; color: #666; }
    .header-btns { display: flex; gap: 12px; align-items: center; }
    .btn { padding: 10px 20px; border-radius: 8px; font-weight: 500; font-size: 14px; cursor: pointer; transition: all 0.2s; border: none; text-decoration: none; display: inline-flex; align-items: center; gap: 6px; }
    .btn-secondary { background: #1a1a1a; border: 1px solid #2a2a2a; color: #fff; }
    .btn-secondary:hover { background: #252525; }
    .btn-primary { background: #3b82f6; color: #fff; }
    .btn-primary:hover { background: #2563eb; }
    .status-badge { padding: 8px 12px; border-radius: 8px; font-size: 13px; display: flex; align-items: center; gap: 6px; }
    .status-live { background: rgba(0, 210, 106, 0.15); color: #00d26a; }
    .status-demo { background: rgba(251, 191, 36, 0.15); color: #fbbf24; }
    .status-dot { width: 8px; height: 8px; border-radius: 50%; animation: pulse 2s infinite; }
    .status-live .status-dot { background: #00d26a; }
    .status-demo .status-dot { background: #fbbf24; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    /* Main */
    .main { max-width: 1400px; margin: 0 auto; padding: 24px; }
    
    /* Stats */
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    @media (max-width: 768px) { .stats { grid-template-columns: repeat(2, 1fr); } }
    .stat-card { background: #141414; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px; }
    .stat-card p { color: #666; font-size: 13px; margin-bottom: 4px; }
    .stat-card h2 { font-size: 28px; font-weight: 600; }
    .text-green { color: #00d26a; }
    
    /* Filters */
    .filters { background: #1c1c1c; border: 1px solid #2a2a2a; border-radius: 12px; padding: 20px; margin-bottom: 24px; }
    .filters-row { display: flex; flex-wrap: wrap; gap: 16px; align-items: flex-end; }
    .filter-group { flex: 1; min-width: 140px; }
    .filter-group label { display: block; font-size: 12px; color: #666; margin-bottom: 6px; text-transform: uppercase; }
    .select, .input { width: 100%; background: #1a1a1a; border: 1px solid #2a2a2a; border-radius: 8px; padding: 10px 14px; color: #fff; font-size: 14px; outline: none; }
    .select:focus, .input:focus { border-color: #3b82f6; }
    .filter-group.search { flex: 2; }
    
    /* Table */
    .table-card { background: #1c1c1c; border: 1px solid #2a2a2a; border-radius: 12px; overflow: hidden; }
    .table-scroll { overflow-x: auto; }
    table { width: 100%; min-width: 800px; border-collapse: collapse; }
    thead tr { background: #141414; }
    th { padding: 14px 16px; text-align: left; font-size: 12px; color: #666; text-transform: uppercase; font-weight: 500; border-bottom: 1px solid #2a2a2a; cursor: pointer; user-select: none; }
    th:hover { color: #fff; }
    th.sorted { color: #3b82f6; }
    tbody tr { border-bottom: 1px solid #2a2a2a; cursor: pointer; transition: background 0.15s; }
    tbody tr:hover { background: #1a1a1a; }
    tbody tr:last-child { border-bottom: none; }
    td { padding: 14px 16px; }
    
    /* Rank badges */
    .rank { width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; }
    .rank-1 { background: linear-gradient(135deg, #fbbf24, #f59e0b); color: #000; }
    .rank-2 { background: linear-gradient(135deg, #94a3b8, #64748b); color: #000; }
    .rank-3 { background: linear-gradient(135deg, #d97706, #b45309); color: #000; }
    .rank-default { background: #1a1a1a; color: #666; }
    
    /* Trader info */
    .trader-info { display: flex; flex-direction: column; }
    .trader-name { font-weight: 500; display: flex; align-items: center; gap: 6px; }
    .verified { background: #3b82f6; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .wallet { font-size: 12px; color: #666; font-family: monospace; }
    
    /* PnL */
    .pnl-positive { color: #00d26a; font-weight: 600; }
    .pnl-negative { color: #ff4757; font-weight: 600; }
    
    /* Loading & Error */
    .loading, .error { text-align: center; padding: 60px 20px; color: #666; }
    .loading-spinner { width: 24px; height: 24px; border: 2px solid #2a2a2a; border-top-color: #3b82f6; border-radius: 50%; animation: spin 0.8s linear infinite; margin: 0 auto 12px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .error { color: #ff4757; }
    .error button { margin-top: 12px; }
    
    /* Modal */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(4px); z-index: 50; display: none; align-items: flex-start; justify-content: center; padding: 10vh 16px; overflow-y: auto; }
    .modal-overlay.active { display: flex; }
    .modal { background: #1c1c1c; border: 1px solid #2a2a2a; border-radius: 16px; width: 100%; max-width: 640px; }
    .modal-header { padding: 24px; border-bottom: 1px solid #2a2a2a; display: flex; justify-content: space-between; }
    .modal-header h2 { font-size: 20px; display: flex; align-items: center; gap: 8px; }
    .modal-header .wallet { margin-top: 4px; }
    .modal-links { display: flex; gap: 8px; margin-top: 12px; }
    .modal-links a { font-size: 12px; padding: 6px 12px; }
    .close-btn { width: 32px; height: 32px; border-radius: 8px; background: #1a1a1a; border: none; color: #666; cursor: pointer; font-size: 18px; }
    .close-btn:hover { background: #252525; color: #fff; }
    .modal-stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; padding: 24px; background: #141414; border-bottom: 1px solid #2a2a2a; }
    .modal-stat { text-align: center; }
    .modal-stat h3 { font-size: 20px; font-weight: 600; }
    .modal-stat p { font-size: 12px; color: #666; margin-top: 4px; }
    .modal-positions { padding: 24px; }
    .modal-positions h3 { font-weight: 500; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }
    .pos-filters { display: flex; gap: 4px; }
    .pos-filter { padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500; background: #1a1a1a; border: none; color: #666; cursor: pointer; }
    .pos-filter.active { background: #3b82f6; color: #fff; }
    .positions-list { max-height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .position-card { background: #141414; border: 1px solid #2a2a2a; border-radius: 10px; padding: 16px; display: flex; align-items: center; justify-content: space-between; gap: 16px; cursor: pointer; transition: all 0.2s; text-decoration: none; color: inherit; }
    .position-card:hover { border-color: #3a3a3a; transform: translateX(4px); }
    .position-card.yes { border-left: 3px solid #00d26a; }
    .position-card.no { border-left: 3px solid #ff4757; }
    .position-info { flex: 1; min-width: 0; }
    .position-info h4 { font-size: 14px; font-weight: 500; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .position-info p { font-size: 12px; color: #666; margin-top: 2px; }
    .badge { padding: 4px 10px; border-radius: 6px; font-size: 12px; font-weight: 500; }
    .badge-green { background: rgba(0, 210, 106, 0.15); color: #00d26a; }
    .badge-red { background: rgba(255, 71, 87, 0.15); color: #ff4757; }
    .position-value { text-align: right; min-width: 80px; }
    .position-value h4 { font-weight: 500; }
    .position-value p { font-size: 12px; margin-top: 2px; }
    
    /* Footer */
    .footer { margin-top: 32px; padding: 24px 0; border-top: 1px solid #2a2a2a; text-align: center; color: #666; font-size: 13px; }
    .footer a { color: #3b82f6; text-decoration: none; }
    .footer a:hover { text-decoration: underline; }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="logo">
      <div class="logo-icon">P</div>
      <div class="logo-text">
        <h1>Polymarket Leaderboard</h1>
        <p>Top 200 Traders</p>
      </div>
    </div>
    <div class="header-btns">
      <a href="https://polymarket.com" target="_blank" class="btn btn-secondary">Open Polymarket ↗</a>
      <div id="statusBadge" class="status-badge status-demo">
        <div class="status-dot"></div>
        <span>Loading...</span>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="main">
    <!-- Stats -->
    <div class="stats">
      <div class="stat-card">
        <p>Total Traders</p>
        <h2 id="statTotal">-</h2>
      </div>
      <div class="stat-card">
        <p>Top PnL</p>
        <h2 id="statTopPnl" class="text-green">-</h2>
      </div>
      <div class="stat-card">
        <p>Total Volume</p>
        <h2 id="statVolume">-</h2>
      </div>
      <div class="stat-card">
        <p>Avg ROI (Top 10)</p>
        <h2 id="statRoi" class="text-green">-</h2>
      </div>
    </div>

    <!-- Filters -->
    <div class="filters">
      <div class="filters-row">
        <div class="filter-group">
          <label>Period</label>
          <select id="filterPeriod" class="select">
            <option value="all">All Time</option>
            <option value="monthly">Monthly</option>
            <option value="weekly">Weekly</option>
            <option value="daily">Daily</option>
          </select>
        </div>
        <div class="filter-group">
          <label>Min PnL</label>
          <select id="filterPnl" class="select">
            <option value="0">All</option>
            <option value="10000">$10K+</option>
            <option value="50000">$50K+</option>
            <option value="100000">$100K+</option>
            <option value="500000">$500K+</option>
            <option value="1000000">$1M+</option>
          </select>
        </div>
        <div class="filter-group search">
          <label>Search</label>
          <input type="text" id="filterSearch" class="input" placeholder="Search trader name...">
        </div>
        <button id="refreshBtn" class="btn btn-primary">↻ Refresh</button>
      </div>
    </div>

    <!-- Table -->
    <div class="table-card">
      <div class="table-scroll">
        <table>
          <thead>
            <tr>
              <th>Rank</th>
              <th>Trader</th>
              <th id="sortPnl" class="sorted">PnL ↓</th>
              <th id="sortVolume">Volume</th>
              <th id="sortTrades">Trades</th>
              <th id="sortRoi">ROI</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="tableBody">
            <tr><td colspan="7" class="loading"><div class="loading-spinner"></div>Loading traders...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Footer -->
    <div class="footer">
      Data from <a href="https://polymarket.com" target="_blank">Polymarket</a> · Trading involves risk · Not financial advice
    </div>
  </main>

  <!-- Modal -->
  <div id="modal" class="modal-overlay" onclick="closeModal()">
    <div class="modal" onclick="event.stopPropagation()">
      <div class="modal-header">
        <div>
          <h2 id="modalName">Trader Name <span class="verified">✓</span></h2>
          <p class="wallet" id="modalWallet">0x...</p>
          <div class="modal-links">
            <a id="linkPoly" href="#" target="_blank" class="btn btn-secondary">Polymarket ↗</a>
            <a id="linkScan" href="#" target="_blank" class="btn btn-secondary">Polygonscan ↗</a>
          </div>
        </div>
        <button class="close-btn" onclick="closeModal()">✕</button>
      </div>
      <div class="modal-stats">
        <div class="modal-stat">
          <h3 id="modalPnl" class="text-green">+$0</h3>
          <p>Total PnL</p>
        </div>
        <div class="modal-stat">
          <h3 id="modalVolume">$0</h3>
          <p>Volume</p>
        </div>
        <div class="modal-stat">
          <h3 id="modalTrades">0</h3>
          <p>Trades</p>
        </div>
        <div class="modal-stat">
          <h3 id="modalRoi" class="text-green">0%</h3>
          <p>ROI</p>
        </div>
      </div>
      <div class="modal-positions">
        <h3>
          Open Positions
          <div class="pos-filters">
            <button class="pos-filter active" data-filter="all">All</button>
            <button class="pos-filter" data-filter="YES">YES</button>
            <button class="pos-filter" data-filter="NO">NO</button>
          </div>
        </h3>
        <div id="positionsList" class="positions-list">
          <div class="loading"><div class="loading-spinner"></div>Loading positions...</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // State
    let traders = [];
    let filteredTraders = [];
    let positions = [];
    let posFilter = 'all';
    let sortField = 'pnl';
    let sortDir = 'desc';
    let isLive = false;
    let selectedTrader = null;

    // Format helpers
    const formatMoney = (v) => {
      const abs = Math.abs(v);
      if (abs >= 1e6) return '$' + (v / 1e6).toFixed(2) + 'M';
      if (abs >= 1e3) return '$' + (v / 1e3).toFixed(1) + 'K';
      return '$' + v.toFixed(0);
    };
    const formatPnl = (v) => (v >= 0 ? '+' : '') + formatMoney(v);

    // Update status badge
    const updateStatus = (live) => {
      isLive = live;
      const badge = document.getElementById('statusBadge');
      badge.className = 'status-badge ' + (live ? 'status-live' : 'status-demo');
      badge.querySelector('span').textContent = live ? 'Live' : 'Demo';
    };

    // Update stats
    const updateStats = () => {
      document.getElementById('statTotal').textContent = filteredTraders.length;
      document.getElementById('statTopPnl').textContent = filteredTraders[0] ? formatMoney(filteredTraders[0].pnl) : '-';
      document.getElementById('statVolume').textContent = formatMoney(filteredTraders.reduce((s, t) => s + t.volume, 0));
      const top10 = filteredTraders.slice(0, 10);
      const avgRoi = top10.length > 0 ? top10.reduce((s, t) => s + t.roi, 0) / top10.length : 0;
      document.getElementById('statRoi').textContent = avgRoi.toFixed(1) + '%';
    };

    // Render table
    const renderTable = () => {
      const tbody = document.getElementById('tableBody');
      
      if (filteredTraders.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7" class="loading">No traders found</td></tr>';
        return;
      }

      tbody.innerHTML = filteredTraders.map(t => `
        <tr onclick="openModal('${t.wallet}')">
          <td>
            <div class="rank ${t.rank <= 3 ? 'rank-' + t.rank : 'rank-default'}">${t.rank}</div>
          </td>
          <td>
            <div class="trader-info">
              <span class="trader-name">${t.username} ${t.verified ? '<span class="verified">✓</span>' : ''}</span>
              <span class="wallet">${t.wallet.slice(0, 8)}...</span>
            </div>
          </td>
          <td class="${t.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">${formatPnl(t.pnl)}</td>
          <td>${formatMoney(t.volume)}</td>
          <td>${t.positions}</td>
          <td class="${t.roi >= 0 ? 'pnl-positive' : 'pnl-negative'}">${t.roi.toFixed(1)}%</td>
          <td><button class="btn btn-secondary" style="padding: 6px 12px; font-size: 12px;">View</button></td>
        </tr>
      `).join('');

      updateStats();
    };

    // Filter & sort
    const applyFilters = () => {
      const minPnl = parseInt(document.getElementById('filterPnl').value) || 0;
      const search = document.getElementById('filterSearch').value.toLowerCase();

      filteredTraders = traders.filter(t => {
        if (t.pnl < minPnl) return false;
        if (search && !t.username.toLowerCase().includes(search)) return false;
        return true;
      });

      filteredTraders.sort((a, b) => {
        const va = a[sortField];
        const vb = b[sortField];
        return sortDir === 'desc' ? vb - va : va - vb;
      });

      renderTable();
    };

    // Sort handler
    const handleSort = (field) => {
      if (sortField === field) {
        sortDir = sortDir === 'desc' ? 'asc' : 'desc';
      } else {
        sortField = field;
        sortDir = 'desc';
      }

      document.querySelectorAll('th').forEach(th => th.classList.remove('sorted'));
      document.getElementById('sort' + field.charAt(0).toUpperCase() + field.slice(1)).classList.add('sorted');
      document.getElementById('sort' + field.charAt(0).toUpperCase() + field.slice(1)).textContent = 
        field.charAt(0).toUpperCase() + field.slice(1) + (sortDir === 'desc' ? ' ↓' : ' ↑');

      applyFilters();
    };

    // Fetch leaderboard
    const fetchLeaderboard = async () => {
      const tbody = document.getElementById('tableBody');
      tbody.innerHTML = '<tr><td colspan="7" class="loading"><div class="loading-spinner"></div>Loading traders...</td></tr>';

      const period = document.getElementById('filterPeriod').value;

      try {
        const res = await fetch(`/api/leaderboard?window=${period}&limit=200`);
        const json = await res.json();

        if (json.success && json.data && json.data.length > 0) {
          traders = json.data;
          updateStatus(true);
        } else {
          throw new Error(json.error || 'No data');
        }
      } catch (err) {
        console.error('Fetch error:', err);
        tbody.innerHTML = `<tr><td colspan="7" class="error">
          ❌ Failed to load: ${err.message}<br>
          <button class="btn btn-primary" onclick="fetchLeaderboard()">Retry</button>
        </td></tr>`;
        updateStatus(false);
        return;
      }

      applyFilters();
    };

    // Open modal
    const openModal = async (wallet) => {
      selectedTrader = traders.find(t => t.wallet === wallet);
      if (!selectedTrader) return;

      document.getElementById('modalName').innerHTML = selectedTrader.username + 
        (selectedTrader.verified ? ' <span class="verified">✓</span>' : '');
      document.getElementById('modalWallet').textContent = wallet;
      document.getElementById('modalPnl').textContent = formatPnl(selectedTrader.pnl);
      document.getElementById('modalPnl').className = selectedTrader.pnl >= 0 ? 'text-green' : 'pnl-negative';
      document.getElementById('modalVolume').textContent = formatMoney(selectedTrader.volume);
      document.getElementById('modalTrades').textContent = selectedTrader.positions;
      document.getElementById('modalRoi').textContent = selectedTrader.roi.toFixed(1) + '%';
      document.getElementById('linkPoly').href = `https://polymarket.com/profile/${wallet}`;
      document.getElementById('linkScan').href = `https://polygonscan.com/address/${wallet}`;

      document.getElementById('modal').classList.add('active');
      document.getElementById('positionsList').innerHTML = '<div class="loading"><div class="loading-spinner"></div>Loading positions...</div>';

      // Fetch positions
      try {
        const res = await fetch(`/api/positions?wallet=${wallet}`);
        const json = await res.json();
        positions = json.success && json.data ? json.data : [];
      } catch {
        positions = [];
      }

      renderPositions();
    };

    // Render positions
    const renderPositions = () => {
      const list = document.getElementById('positionsList');
      const filtered = posFilter === 'all' ? positions : positions.filter(p => p.side === posFilter);

      if (filtered.length === 0) {
        list.innerHTML = '<div class="loading">No positions found</div>';
        return;
      }

      list.innerHTML = filtered.map(p => `
        <a href="https://polymarket.com/event/${p.slug}" target="_blank" class="position-card ${p.side.toLowerCase()}">
          <div class="position-info">
            <h4>${p.market}</h4>
            <p>Avg: ${p.avgPrice}¢</p>
          </div>
          <span class="badge ${p.side === 'YES' ? 'badge-green' : 'badge-red'}">${p.side}</span>
          <div class="position-value">
            <h4>$${p.size.toLocaleString()}</h4>
            <p class="${p.pnl >= 0 ? 'pnl-positive' : 'pnl-negative'}">${formatPnl(p.pnl)}</p>
          </div>
        </a>
      `).join('');
    };

    // Close modal
    const closeModal = () => {
      document.getElementById('modal').classList.remove('active');
      selectedTrader = null;
    };

    // Event listeners
    document.getElementById('filterPeriod').addEventListener('change', fetchLeaderboard);
    document.getElementById('filterPnl').addEventListener('change', applyFilters);
    document.getElementById('filterSearch').addEventListener('input', applyFilters);
    document.getElementById('refreshBtn').addEventListener('click', fetchLeaderboard);

    document.getElementById('sortPnl').addEventListener('click', () => handleSort('pnl'));
    document.getElementById('sortVolume').addEventListener('click', () => handleSort('volume'));
    document.getElementById('sortTrades').addEventListener('click', () => handleSort('positions'));
    document.getElementById('sortRoi').addEventListener('click', () => handleSort('roi'));

    document.querySelectorAll('.pos-filter').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.pos-filter').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        posFilter = btn.dataset.filter;
        renderPositions();
      });
    });

    // Keyboard
    document.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') closeModal();
    });

    // Init
    fetchLeaderboard();
  </script>
</body>
</html>
